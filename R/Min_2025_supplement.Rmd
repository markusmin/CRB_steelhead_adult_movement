---
title: "Supplemental Material"
author: "Markus A. Min, Rebecca A. Buchanan, and Mark D. Scheuerell"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
  pdf_document:
    toc: true
    toc_depth: '3'
subtitle: Modeling climate and hydropower influences on the movement decisions of an anadromous species
bibliography: Steelhead.bib
csl: ecology.csl
---

```{r, echo = FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(here)
library(kableExtra)
library(ggthemes)
library(viridis)
library(ggpubr)
```

## Supplemental Methods

### 1 Tributary detection efficiency

Detection efficiency at the in-stream PIT tag array closest to the mouth of the tributary (the confluence of the tributary with the mainstem Columbia or Snake River) was estimated for each tributary state. However, detection efficiency was not modeled for three tributaries of the Snake River (the Salmon River, the Grande Ronde River, and the Clearwater River), as these tributaries did not have a detection site on the mainstem of the tributary within 100 km of the confluence. The data used to estimate detection efficiency at the river mouth sites was detections at the river mouth site and detections anywhere upstream of the river mouth site. In this analysis, we only included fish that were detected at a river mouth site, and then used a binary indicator to record if those fish were also detected at the river mouth site.

We modeled detection efficiency in tributaries using logistic regression based on two predictors: 1) changes in antenna configurations over time, and 2) the discharge in the tributary. Changes in antenna configurations were identified from the operational history of the site, based on antennas being installed, decommissioned, upgraded, or moved. Changes in antenna configurations are identified in Table S1. Discharge was included as a predictor based on our hypothesis that river stage would influence the antenna coverage of the river channel. Discharge data were queried from USGS by finding the station on the interactive USGS dashboard closest the river mouth array and navigating to the data page for the specific site. Discharge data were available for all tributaries except Fifteenmile Creek and the Imnaha River; detection efficiency in these tributaries was therefore only modeled as a function of antenna configurations. We processed discharge data for inclusion in the model by taking the mean discharge across the run year.

*Table S1: Tributary PIT tag antenna configurations used in detection efficiency estimation. Years refer to the Steelhead run years in which the site was active in a specific configuration. Site refers to the PIT tag detection site chosen for the detection efficiency estimation, based on its proximity to the mouth of the tributary. Configuration refers to the configuration of antennas at the site, where Initial is the name given to the antenna configuration at the site at the start of the time series, and any subsequent changes from the initial configuration at the site are noted in this column.*

| Tributary | Years |	Site | Configuration |
|:----|:----|:----|:----|
| Hood River	 | 12/13-21/22	 | Hood River Mouth (HRM)	 | Initial |
| Fifteenmile Creek	 | 11/12-18/19	 | Fifteenmile Ck at Eighmile Ck (158)	| Initial |
| Deschutes River	 | 13/14-18/19	 | Deschutes River Mouth (DRM)	| Initial |
| John Day River	 | 12/13-21/22	 | John Day River, McDonald Ferry (JD1)	| Initial |
| Umatilla River | 	06/07-13/14	 | Three Mile Falls Dam (TMF)	| Initial |
| Umatilla River	 | 14/15-21/22	 | Three Mile Falls Dam (TMF)	| Antenna installation at entrance to adult ladder | 
| Walla Walla River	 | 05/06-11/12	 | Oasis Road Bridge (ORB)	| Initial |
| Walla Walla River	 | 12/13-14/15	 | Oasis Road Bridge (ORB) and Walla Walla R at Pierce RV Pk (PRV)	| Initial configuration where two mouth sites were operational simultaneously and their joint detection efficiency was estimated |
| Walla Walla River	 | 15/16-18/19	 | Walla Walla R at Pierce RV Pk (PRV)	| Initial |
| Walla Walla River	 | 19/20-21/22	 | Walla Walla River Barge Array (WWB)	| Initial |
| Yakima River	 | 05/06-21/22	 | Prosser Diversion Dam (PRO)	| Initial |
| Wenatchee River	 | 10/11-21/22	 | Lower Wenatchee River (LWE)	| Initial |
| Entiat River	 | 07/08-21/22	 | Lower Entiat River (ENL)	| Initial |
| Methow River	 | 09/10-16/17 | 	Lower Methow River at Pateros (LMR)	| Initial |
| Methow River	 | 17/18-21/22 | 	Lower Methow River at Pateros (LMR) |	Site was moved 5 km upstream and transceivers replaced |
| Okanogan River	 | 13/14-21/22 | 	Lower Okanogan Instream Array (OKL)	| Initial |
| Tucannon River	 | 10/11-19/20 | 	Lower Tucannon River (LTR)	| Initial |
| Tucannon River	 | 20/21-21/22 | 	Lower Tucannon River (LTR) |	All antennas replaced, additional antenna installed |
| Asotin Creek	 | 11/12-17/18 | 	Asotin Creek Mouth (ACM)	| Initial |
| Asotin Creek	 | 18/19-21/22 | 	Asotin Creek Mouth (ACM) | 	All components replaced and upgraded |
| Imnaha River	 | 10/11-21/22 | 	Lower Imnaha River ISA @ km 7 (IR1)	| Initial |

For our model of detection efficiency, we denote $z_i$ as the detection of a fish that was detected at an upstream site $i$ at the river mouth site, $p_det$ as the probability of detection for fish $i$, $\alpha_{j,k}$ as the antenna configuration for tributary $j$ under configuration $k$, $\beta_j$ as the slope for the effect of discharge, and $x_{j,t}$ as the mean discharge for tributary $j$ in year $t$. The model for detection efficiency was as follows:

$$
z_i \sim Bernoulli(p_{det,i}) \\
logit(p_{det,i}) =\alpha_{j,k} + \beta_j x_{j,t}
$$

The above model was implemented in Stan (Carpenter et al., 2017), with 3 chains run for 5,000 warmup and 5,000 sampling iterations each. Discharge values were Z-scored prior to the model being fit. The posteriors from this model for each of the $\alpha$ (site configuration intercepts) and $\beta$ (effect of discharge) terms were used as priors in the primary Stan model that was used to estimate movement. The resulting detection efficiency correction for each run year can be found in Fig. S1.



### 2 Covariate data processing

#### Temperature data
Due to the noise and gaps inherent to the temperature data, a series of steps were performed to clean this data. First, plots of temperature were manually inspected and sequential runs of temperature points that were outside of the range of possible values for that time of year were removed. Next, a filtering algorithm was applied to remove any temperature values that were more than four degrees outside of the interannual average temperature value for that day of the year, as well as any values that were more than two degrees outside of the 7-day moving average. To address the incomplete temporal resolution for temperature at each dam in our modeling framework, a state-space model was fit using the MARSS package (Holmes et al., 2014). The inputs for this model were the cleaned temperature data at the forebay and tailrace for the eight dams (a total of 16 temperature time series). The model was structured with only a single process (the basin-scale temperature) and 16 observations of that process. Each dam had a different offset/bias term (8 total). Model-estimated temperatures on each day for each dam were then exported by using the estimate of the basin-scale temperature plus the dam-specific offset.

To estimate the temperatures experienced by fish, the median residence time in each state in our model was first calculated. To do so, we calculated the difference between the date on which a fish was observed exiting a state and the date on which a fish was observed entering a state, and then computed the state-specific median across all fish. However, for the two furthest upstream states (upstream of Lower Granite Dam and upstream of Wells Dam), residence times were significantly longer and were found to be bimodal. These furthest upstream states are also observed to have more variability in median residence times because of their position in the PIT tag array network (see plots below). Based on our hypothesis that movement decisions are made soon after a fish enters a state, we fit a two-component mixture model using the mixtools package in R (Benaglia et al., 2010) to residence times in these states and used the median residence time for fish in the first mode. The mean temperature experienced by the fish while in a state was estimated as the mean temperature across a window of time defined as the date a fish was observed entering a state plus the median residence time for all fish in that state. 

#### Spill data
Daily average spill (in thousands of cubic feet per second) was queried from the Columbia Basin Conditions portal from the DART page for the eight dams that were modeled as the boundaries of states (Bonneville, McNary, Priest Rapids, Rock Island, Rocky Reach, Wells, Ice Harbor, and Lower Granite). Spill data were processed in two different ways to facilitate the inclusion of two hypothesized relationships between spill and fish fallback over dams. For en-route fallback, spill volume was processed in the same way as temperature: by taking the mean volume of spill across the residence time window. For post-overshoot fallback, spill volume was converted into days of winter spill, by counting the number of days that had nonzero spill in the months of January, February, and March for each year.

Residence time was calculated across all fish and all years. Variability in residence time by year (visualized below as the median residence time by year with the error bars showing the 95% interquantile range) was generally not significant. Furthermore, dividing up the dataset by year would have led to very small sample sizes in some years, leading to an unrepresentative residence time.


```{r residence_time_plots, fig.dim = c(8,6)}
## Load fish movement data to calculate windows
snake_adults_states_complete <- read.csv(here::here("intermediate_outputs", "adults_states_complete", "snake_adults_states_complete.csv"))
midcol_adults_states_complete <- read.csv(here::here("intermediate_outputs", "adults_states_complete", "middle_columbia_adults_states_complete.csv"))
uppcol_adults_states_complete <- read.csv(here::here("intermediate_outputs", "adults_states_complete", "upper_columbia_adults_states_complete.csv"))

# combine all
snake_adults_states_complete %>% 
  bind_rows(., midcol_adults_states_complete) %>% 
  bind_rows(., uppcol_adults_states_complete) -> ASC

# now add tag code metadata, for natal origins
origin_numeric <- data.frame(natal_origin = c("Asotin_Creek", 
                                              "Clearwater_River",
                                              "Deschutes_River", 
                                              "Entiat_River", 
                                              "Fifteenmile_Creek", 
                                              "Grande_Ronde_River", 
                                              "Imnaha_River",
                                              "John_Day_River", 
                                              "Methow_River", 
                                              "Okanogan_River", 
                                              "Salmon_River", 
                                              "Tucannon_River", 
                                              "Umatilla_River",
                                              "Walla_Walla_River",
                                              "Wenatchee_River", 
                                              "Yakima_River"),
                             natal_origin_numeric = seq(1,16,1))

origin_rear_actual <- read.csv(here::here("Data", "covariate_data", "origin_rear_actual.csv"), row.names = 1)
origin_rear_actual %>% 
  dplyr::rename(natal_origin_numeric = natal_origin) %>% 
  left_join(origin_numeric, by = "natal_origin_numeric") %>% 
  dplyr::select(tag_code_2, natal_origin) -> tag_code_origins

ASC %>% 
  left_join(., tag_code_origins, by = "tag_code_2") -> ASC

# also note which ESU they're from, for plotting
ESU_origins <- data.frame(natal_origin = unique(ASC$natal_origin),
                          ESU = c(rep("Snake", 6),
                                  rep("Middle Columbia", 6),
                                  rep("Upper Columbia", 4)))

ASC %>% 
  left_join(., ESU_origins, by = "natal_origin") -> ASC

# explore how residence time changes by year
residence_time <- function(residence_state){

  # filter to the state of interest, but don't keep any with implicit time interpolated
  ASC %>%
    filter(state == residence_state & tag_code_2 == lead(tag_code_2) & pathway != "implicit" & lead(pathway) != "implicit" |
             lag(state) == residence_state & tag_code_2 == lag(tag_code_2) & pathway != "implicit" & lag(pathway) != "implicit") %>%
    mutate(date_time = ymd_hms(date_time)) -> one_state_df


  # make a data frame to record all of the transitions
  n_transitions <- nrow(one_state_df)/2
  passage_df <- data.frame(tag_code_2 = one_state_df$tag_code_2[seq(1,(nrow(one_state_df)-1),2)],
                           year = year(one_state_df$date_time[seq(1,(nrow(one_state_df)-1),2)]),
                           ESU = one_state_df$ESU[seq(1,(nrow(one_state_df)-1),2)],
                           natal_origin = one_state_df$natal_origin[seq(1,(nrow(one_state_df)-1),2)],
                           passage_time = NA)


  for (i in 1:nrow(passage_df)){
    passage_df$passage_time[i] <- one_state_df$date_time[(i*2)] - one_state_df$date_time[(i*2-1)]

  }

  return(passage_df)

}

# explore residence time by DPS, year, and state
main_mainstem_states <- c(
  "mainstem, BON to MCN",
  "mainstem, MCN to ICH or PRA",
  "mainstem, PRA to RIS",
  "mainstem, RIS to RRE",
  "mainstem, RRE to WEL",
  "mainstem, ICH to LGR",
  "mainstem, upstream of WEL",
  "mainstem, upstream of LGR")

plot_residence_time_state_year <- function(state){
  passage_df <- residence_time(residence_state = state)
  
  # create summary table by year
  passage_df %>% 
    group_by(year) %>% 
    summarise(passage_time = quantile(passage_time, c(0.025, 0.5, 0.975)), q = c(0.025, 0.5, 0.975)) %>% 
    pivot_wider(., values_from = passage_time, names_from = q) %>% 
    filter(year <= 2023) -> passage_year_sum
  
  # plot residence time
  plot <- ggplot(passage_year_sum, aes(x = year, y = `0.5`, ymin = `0.025`, ymax = `0.975`)) +
    geom_point() +
    geom_errorbar() +
    ggtitle(state) +
    scale_x_continuous(breaks = c(2005, 2010, 2015, 2020)) +
    ylab("Residence Time")
  
  # plot sample sizes by year
  passage_df %>% 
    group_by(year) %>% 
    summarise(total = n()) %>% 
    filter(year <= 2023) -> passage_sample_sizes
  
  sample_size_plot <- ggplot(passage_sample_sizes, aes(x = year, y = total)) +
    geom_bar(stat = "identity") +
    scale_x_continuous(breaks = c(2005, 2010, 2015, 2020))
  
  final_plot <- ggarrange(plot, sample_size_plot, nrow = 2)
  
  return(final_plot)
}

BON_MCN_plot <- plot_residence_time_state_year(state = main_mainstem_states[1])
MCN_ICH_PRA_plot <- plot_residence_time_state_year(state = main_mainstem_states[2])
PRA_RIS_plot <- plot_residence_time_state_year(state = main_mainstem_states[3])
RIS_RRE_plot <- plot_residence_time_state_year(state = main_mainstem_states[4])
RRE_WEL_plot <- plot_residence_time_state_year(state = main_mainstem_states[5])
ICH_LGR_plot <- plot_residence_time_state_year(state = main_mainstem_states[6])
upstream_WEL_plot <- plot_residence_time_state_year(state = main_mainstem_states[7])
upstream_LGR_plot <- plot_residence_time_state_year(state = main_mainstem_states[8])

BON_MCN_plot
MCN_ICH_PRA_plot
PRA_RIS_plot
RIS_RRE_plot
RRE_WEL_plot
ICH_LGR_plot
upstream_WEL_plot
upstream_LGR_plot
```




## Supplemental Results

### 1 Sample sizes
```{r}
# Step 1: Load the model_data files to ensure that we are pulling the exact same
# data as what is going into the model
load(here::here("Stan", "upper_columbia_wild", "UCW_model_data.rda"))
UCW_data <- data
load(here::here("Stan", "upper_columbia_hatchery", "UCH_model_data.rda"))
UCH_data <- data
load(here::here("Stan", "middle_columbia_wild", "MCW_model_data.rda"))
MCW_data <- data
load(here::here("Stan", "middle_columbia_hatchery", "MCH_model_data.rda"))
MCH_data <- data
load(here::here("Stan", "snake_river_wild", "SRW_model_data.rda"))
SRW_data <- data
load(here::here("Stan", "snake_river_hatchery", "SRH_model_data.rda"))
SRH_data <- data

# load some useful info
# get the model states into a df, to help with interpretation
model_states = c(
  # Mainstem states (9)
  "mainstem, mouth to BON",
  "mainstem, BON to MCN",
  "mainstem, MCN to ICH or PRA",
  "mainstem, PRA to RIS",
  "mainstem, RIS to RRE",
  "mainstem, RRE to WEL",
  "mainstem, upstream of WEL",
  "mainstem, ICH to LGR",
  "mainstem, upstream of LGR",
  
  # Tributary states ()
  # With detection efficiencies in the model, we now have more tributary states,
  # since we have an upstream and a river mouth state
  
  # "Deschutes River", 
  "Deschutes River Mouth", "Deschutes River Upstream",
  # "John Day River", 
  "John Day River Mouth", "John Day River Upstream",
  # "Hood River",
  # "Hood River Mouth", "Hood River Upstream",
  # "Fifteenmile Creek", 
  "Fifteenmile Creek Mouth", "Fifteenmile Creek Upstream",
  # "Umatilla River",
  "Umatilla River Mouth", "Umatilla River Upstream",
  # "Yakima River",
  "Yakima River Mouth", "Yakima River Upstream",
  # "Walla Walla River",
  "Walla Walla River Mouth", "Walla Walla River Upstream",
  # "Wenatchee River", 
  "Wenatchee River Mouth", "Wenatchee River Upstream",
  # "Entiat River", 
  "Entiat River Mouth", "Entiat River Upstream",
  # "Okanogan River", 
  "Okanogan River Mouth", "Okanogan River Upstream",
  # "Methow River", 
  "Methow River Mouth", "Methow River Upstream",
  # "Tucannon River",
  "Tucannon River Mouth", "Tucannon River Upstream",
  # "Asotin Creek", 
  "Asotin Creek Mouth", "Asotin Creek Upstream",
  "Clearwater River",
  "Salmon River",
  "Grande Ronde River",
  # "Imnaha River",
  "Imnaha River Mouth", "Imnaha River Upstream",
  "BON to MCN other tributaries",
  "Upstream WEL other tributaries",
  
  # Loss
  "loss"
)

# Make the origin_param_map
natal_origins <- gsub(" Mouth| Upstream", "", model_states)
natal_origins <- natal_origins[!(duplicated(natal_origins))]
natal_origins <- natal_origins[!(grepl("mainstem", natal_origins))]
natal_origins <- natal_origins[!(grepl("other tributaries", natal_origins))]
natal_origins <- natal_origins[!(natal_origins == "loss")]

# Use the parameter map to index the right effects
origin_param_map <- data.frame(
  natal_origin = natal_origins,
  hatchery = c(NA, NA, NA, 1, NA, 2, # MC
               1,NA,2,3, # UC
               5,NA,1,4,2,3), # SR,
  wild = c(1,3,2,4,6,5, # MC
           1,2,NA,3, # UC
           6,1,2,5,3,4)) # SR

# Add the DPS
DPS_map <- data.frame(
  natal_origin = c("Middle Columbia", "Upper Columbia", "Snake River"),
  hatchery = rep(999, 3),
  wild = rep(999, 3)
)
origin_param_map %>% 
  bind_rows(DPS_map) -> origin_param_map




# Step 2: Write a function that takes a dataset and returns a table
# that contains each fish by origin and run year

extract_run_year_origin <- function(data, rear, DPS, origin_param_map = origin_param_map){
  origin_vector <- vector(length = nrow(data$cat_X_mat))
  for(i in 1:nrow(data$cat_X_mat)){
    origin_vector[i] <- which(data$cat_X_mat[i,]==1)
  }
  
  
  # for spill days - include the winter post-overshoot vector, which contains
  # info on whether they could have experienced winter spill conditions or not
  # add a new fish_ID column, which is not the same as tag code but will allow us to differentiate between fish
  pop_states_run_years <- data.frame(fish_ID = rep(1:length(origin_vector), each = ncol(data$y)),
                                     state = as.vector(t(data$y)),
                                     origin = rep(origin_vector, each = ncol(data$y)))
  
  # drop observations in the loss state and with index 0
  pop_states_run_years %>% 
    filter(!(state %in% c(0,41))) -> pop_states_run_years
  
  # add the run year column
  pop_states_run_years$run_year <- data$transition_run_years
  
  # keep only the first observation of each fish (this is when they are detected
  # at BON, and therefore is their run year)
  pop_states_run_years %>% 
    filter(!(duplicated(fish_ID))) -> fish_state_origin_year
  
  # join with key to translate numeric origin into actual origin
  if (DPS == "Middle Columbia") {
    origin_param_map_DPS <- subset(origin_param_map, natal_origin %in% origin_param_map$natal_origin[1:6])
  } else if (DPS == "Upper Columbia"){
    origin_param_map_DPS <- subset(origin_param_map, natal_origin %in% origin_param_map$natal_origin[7:10])
  } else{
    origin_param_map_DPS <- subset(origin_param_map, natal_origin %in% origin_param_map$natal_origin[11:16])
  }
  
  
  if (rear == "hatchery"){
    fish_state_origin_year %>% 
      left_join(., dplyr::select(origin_param_map_DPS, natal_origin, hatchery), 
                by = join_by(origin == hatchery)) -> fish_state_origin_year
    
    # Add a rear column
    fish_state_origin_year %>% 
      mutate(rear = "hatchery") -> fish_state_origin_year
  } else {
    fish_state_origin_year %>% 
      left_join(., dplyr::select(origin_param_map_DPS, natal_origin, wild), 
                by = join_by(origin == wild)) -> fish_state_origin_year
    
    # Add a rear column
    fish_state_origin_year %>% 
      mutate(rear = "natural") -> fish_state_origin_year
  }
  
  
  
  return(fish_state_origin_year)
  
}

UCW_origin_run_years <- extract_run_year_origin(data = UCW_data, rear = "natural", 
                                                DPS = "Upper Columbia", origin_param_map = origin_param_map)
UCH_origin_run_years <- extract_run_year_origin(data = UCH_data, rear = "hatchery", 
                                                DPS = "Upper Columbia", origin_param_map = origin_param_map)
MCW_origin_run_years <- extract_run_year_origin(data = MCW_data, rear = "natural", 
                                                DPS = "Middle Columbia", origin_param_map = origin_param_map)
MCH_origin_run_years <- extract_run_year_origin(data = MCH_data, rear = "hatchery", 
                                                DPS = "Middle Columbia", origin_param_map = origin_param_map)
SRW_origin_run_years <- extract_run_year_origin(data = SRW_data, rear = "natural", 
                                                DPS = "Snake River", origin_param_map = origin_param_map)
SRH_origin_run_years <- extract_run_year_origin(data = SRH_data, rear = "hatchery", 
                                                DPS = "Snake River", origin_param_map = origin_param_map)

UCW_origin_run_years %>% 
  bind_rows(., UCH_origin_run_years) %>% 
  bind_rows(., MCW_origin_run_years) %>% 
  bind_rows(., MCH_origin_run_years) %>% 
  bind_rows(., SRW_origin_run_years) %>% 
  bind_rows(., SRH_origin_run_years) -> full_origin_run_years

full_origin_run_years %>% 
  group_by(natal_origin, run_year, rear) %>% 
  summarise(count = n()) -> sample_size_long

# Convert numeric run years to actual
# first create the run year df
# NOTE: There are two ways that we index run year numeric (not great.)
# In the model, year 1 is 04/05; in other places where we are plotting run year,
# we have a numeric run year column where 4 = 04/05, 5 = 05/06, etc.
run_year <- c("04/05", "05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24", "24/25")
run_year_start <- seq(ymd_hms("2004-06-01 00:00:00"), ymd_hms("2024-06-01 00:00:00"), by = "years")
run_year_end <- seq(ymd_hms("2005-05-31 23:59:59"), ymd_hms("2025-05-31 23:59:59"), by = "years")
run_year_index = 1:21

run_year_df <- data.frame(run_year, run_year_start, run_year_end, run_year_index)

sample_size_long %>% 
  dplyr::rename(run_year_index = run_year) %>% 
  left_join(run_year_df, by = "run_year_index") %>% 
  dplyr::select(-c(run_year_start, run_year_end)) -> sample_size_long

# change order to be from most downstream to most upstream
tributary_order <- c("Fifteenmile Creek", "Deschutes River", "John Day River",
                     "Umatilla River", "Walla Walla River", "Yakima River", "Wenatchee River",
                     "Entiat River", "Methow River", "Okanogan River",
                     "Tucannon River", "Clearwater River", "Asotin Creek", "Grande Ronde River",
                     "Salmon River", "Imnaha River")


# reformat so that we can export this is a table
sample_size_long %>% 
  ungroup() %>% 
  mutate(run_year = factor(run_year, levels = c("04/05", "05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24", "24/25"))) %>% 
  mutate(natal_origin = factor(natal_origin, levels = tributary_order)) %>% 
  dplyr::select(-c(run_year_index)) %>% 
  arrange(natal_origin, rear, run_year) %>% 
  mutate(population = paste0(natal_origin, " (", ifelse(rear == "natural", "N", "H"), ")")) %>% 
  dplyr::select(-c(natal_origin, rear)) %>% 
  pivot_wider(names_from = run_year, values_from = count) %>% 
  replace(is.na(.), 0) %>%
  relocate(`05/06`, .after = population) %>% 
  relocate(`06/07`, .after = `05/06`) %>% 
  relocate(`07/08`, .after = `06/07`) %>% 
  relocate(`23/24`, .after = `22/23`) %>% 
  bind_rows(summarise(.,
                      across(where(is.numeric), sum),
                      across(where(is.character), ~"Total"))) %>% 
  mutate(Total = rowSums(across(where(is.numeric))))  -> sample_size_table

sample_size_table %>% 
  dplyr::rename("Population" = population) %>% 
  kbl(caption = "The number of fish per run year from each combination of natal tributary and rearing type (natural or hatchery origin).") %>% 
  kable_styling(latex_options = "HOLD_position")
```




### 2 Covariate data summaries {.tabset .tabset-pills}

In this section, we present summaries of the three basin condition covariates incorporated in this model: temperature, spill volume, and number of winter spill days. We first present summary tables that show the differences in these covariates by run year and by dam, and then present figures that show the fine-scale details in these trends by dam and across year. 

```{r}
#### Define functions ####
flow_reformat <- function(input_data, variable_name){
  
  # need to deal with leap years
  leap_years <- seq(1960, 2024, by = 4)
  
  input_data %>% 
    pivot_longer(., cols = colnames(.)[2:ncol(.)]) %>% 
    dplyr::rename(year = name,
                  !!quo_name(variable_name) := value) %>% 
    mutate(year = gsub("X","",year)) %>% 
    mutate(year = as.numeric(year), day = as.numeric(day)) %>% 
    # drop day 366 in non-leap years
    dplyr::filter(!(day == 366 & !(year %in% leap_years))) %>%
    # Add a new column for date (combine year and day)
    mutate(date = format(as.Date(day, origin = paste0(year-1, "-12-31")))) %>% 
    arrange(year, day) %>% 
    # don't include 2025 data
    filter(year <= 2024) -> output_data
  
  return(output_data)
}


spill_reformat <- function(input_data, variable_name){
  
  # need to deal with leap years
  leap_years <- seq(1960, 2024, by = 4)
  
  input_data %>% 
    pivot_longer(., cols = colnames(.)[2:ncol(.)]) %>% 
    dplyr::rename(year = name,
                  !!quo_name(variable_name) := value) %>% 
    mutate(year = gsub("X","",year)) %>% 
    # mutate(spill = spill/100) %>% 
    mutate(year = as.numeric(year), day = as.numeric(day)) %>% 
    # drop day 366 in non-leap years
    dplyr::filter(!(day == 366 & !(year %in% leap_years))) %>%
    # Add a new column for date (combine year and day)
    mutate(date = format(as.Date(day, origin = paste0(year-1, "-12-31")))) %>% 
    arrange(year, day) %>% 
    # don't include 2025 data
    filter(year <= 2024) -> output_data
  
  return(output_data)
}

cov_reformat <- function(input_data, variable_name){
  
  # need to deal with leap years
  leap_years <- seq(1960, 2024, by = 4)
  
  input_data %>% 
    pivot_longer(., cols = colnames(.)[2:ncol(.)]) %>% 
    dplyr::rename(year = name,
                  !!quo_name(variable_name) := value) %>% 
    mutate(year = gsub("X","",year)) %>% 
    mutate(year = as.numeric(year), day = as.numeric(day)) %>% 
    # drop day 366 in non-leap years
    dplyr::filter(!(day == 366 & !(year %in% leap_years))) %>%
    # Add a new column for date (combine year and day)
    mutate(date = format(as.Date(day, origin = paste0(year-1, "-12-31")))) %>% 
    arrange(year, day) %>% 
    # drop all years before 2005
    filter(year >= 2005) -> output_data
  
  
  return(output_data)
}



#### Load and reformat the temperature data ####

# load model estimated temperature
temp_model_est <- read.csv(here::here("Data", "covariate_data", "temp_processed", "temp_mod_est.csv"))

# BON
BON_temp_mod <- dplyr::select(temp_model_est, date, BON) %>% 
  dplyr::rename(temp = BON)
BON_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "BON", "BON_tailrace_temp_2025-02-03.csv"))[1:366,]
BON_temp_t_long <- cov_reformat(input_data = BON_temp_t, variable_name = "temp")
BON_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "BON", "BON_temp_2025-02-03.csv"))[1:366,]
BON_temp_f_long <- cov_reformat(input_data = BON_temp_f, variable_name = "temp")

# ICH
ICH_temp_mod <- dplyr::select(temp_model_est, date, ICH) %>% 
  dplyr::rename(temp = ICH) 
ICH_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "ICH", "ICH_tailrace_temp_2025-02-03.csv"))[1:366,]
ICH_temp_t_long <- cov_reformat(input_data = ICH_temp_t, variable_name = "temp")
ICH_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "ICH", "ICH_temp_2025-02-03.csv"))[1:366,]
ICH_temp_f_long <- cov_reformat(input_data = ICH_temp_f, variable_name = "temp")

# LGR
LGR_temp_mod <- dplyr::select(temp_model_est, date, LGR) %>% 
  dplyr::rename(temp = LGR) 
LGR_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "LGR", "LGR_tailrace_temp_2025-02-03.csv"))[1:366,]
LGR_temp_t_long <- cov_reformat(input_data = LGR_temp_t, variable_name = "temp")
LGR_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "LGR", "LGR_temp_2025-02-03.csv"))[1:366,]
LGR_temp_f_long <- cov_reformat(input_data = LGR_temp_f, variable_name = "temp")

# MCN
MCN_temp_mod <- dplyr::select(temp_model_est, date, MCN) %>% 
  dplyr::rename(temp = MCN)
MCN_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "MCN", "MCN_tailrace_temp_2025-02-03.csv"))[1:366,]
MCN_temp_t_long <- cov_reformat(input_data = MCN_temp_t, variable_name = "temp")
MCN_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "MCN", "MCN_temp_2025-02-03.csv"))[1:366,]
MCN_temp_f_long <- cov_reformat(input_data = MCN_temp_f, variable_name = "temp")


# PRA
PRA_temp_mod <- dplyr::select(temp_model_est, date, PRA) %>% 
  dplyr::rename(temp = PRA) 
PRA_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "PRA", "PRA_tailrace_temp_2025-02-03.csv"))[1:366,]
PRA_temp_t_long <- cov_reformat(input_data = PRA_temp_t, variable_name = "temp")
PRA_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "PRA", "PRA_temp_2025-02-03.csv"))[1:366,]
PRA_temp_f_long <- cov_reformat(input_data = PRA_temp_f, variable_name = "temp")


# RIS
RIS_temp_mod <- dplyr::select(temp_model_est, date, RIS) %>% 
  dplyr::rename(temp = RIS) 
RIS_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RIS", "RIS_tailrace_temp_2025-02-03.csv"))[1:366,]
RIS_temp_t_long <- cov_reformat(input_data = RIS_temp_t, variable_name = "temp")
RIS_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RIS", "RIS_temp_2025-02-03.csv"))[1:366,]
RIS_temp_f_long <- cov_reformat(input_data = RIS_temp_f, variable_name = "temp")


# RRE
RRE_temp_mod <- dplyr::select(temp_model_est, date, RRE) %>% 
  dplyr::rename(temp = RRE)  
RRE_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RRE", "RRE_tailrace_temp_2025-02-03.csv"))[1:366,]
RRE_temp_t_long <- cov_reformat(input_data = RRE_temp_t, variable_name = "temp")
RRE_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RRE", "RRE_temp_2025-02-03.csv"))[1:366,]
RRE_temp_f_long <- cov_reformat(input_data = RRE_temp_f, variable_name = "temp")

# WEL
WEL_temp_mod <- dplyr::select(temp_model_est, date, WEL) %>% 
  dplyr::rename(temp = WEL)  
WEL_temp_t <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "WEL", "WEL_tailrace_temp_2025-02-03.csv"))[1:366,]
WEL_temp_t_long <- cov_reformat(input_data = WEL_temp_t, variable_name = "temp")
WEL_temp_f <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "WEL", "WEL_temp_2025-02-03.csv"))[1:366,]
WEL_temp_f_long <- cov_reformat(input_data = WEL_temp_f, variable_name = "temp")

#### Load and reformat the spill data ####

# BON
BON_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "BON", "BON_spill_2025-02-03.csv"))[1:366,]
BON_spill_long <- spill_reformat(input_data = BON_spill, variable_name = "spill")

# ICH
ICH_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "ICH", "ICH_spill_2025-02-03.csv"))[1:366,]
ICH_spill_long <- spill_reformat(input_data = ICH_spill, variable_name = "spill")

# LGR
LGR_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "LGR", "LGR_spill_2025-02-03.csv"))[1:366,]
LGR_spill_long <- spill_reformat(input_data = LGR_spill, variable_name = "spill")

# MCN
MCN_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "MCN", "MCN_spill_2025-02-03.csv"))[1:366,]
MCN_spill_long <- spill_reformat(input_data = MCN_spill, variable_name = "spill")

# PRA
PRA_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "PRA", "PRA_spill_2025-02-03.csv"))[1:366,]
PRA_spill_long <- spill_reformat(input_data = PRA_spill, variable_name = "spill")

# RIS
RIS_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RIS", "RIS_spill_2025-02-03.csv"))[1:366,]
RIS_spill_long <- spill_reformat(input_data = RIS_spill, variable_name = "spill")

# RRE
RRE_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RRE", "RRE_spill_2025-02-03.csv"))[1:366,]
RRE_spill_long <- spill_reformat(input_data = RRE_spill, variable_name = "spill")

# WEL
WEL_spill <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "WEL", "WEL_spill_2025-02-03.csv"))[1:366,]
WEL_spill_long <- spill_reformat(input_data = WEL_spill, variable_name = "spill")

# so, some gaps in WEL spill data, on Jan 1 and 2 2020, and in December 2021.
# I think it's safe to assume that these are zero, especially looking at typical spill during these months
# let's look at that data
# ggplot(filter(WEL_spill_long, year %in% c(2020, 2021)), aes(x = ymd(date), y = spill)) + geom_point()
# yeah, most likely zeros. will interpolate as such

WEL_spill_long %>% 
  mutate(spill = ifelse(is.na(spill) & year < 2023, 0, spill)) -> WEL_spill_long


#### Load and reformat the flow data ####

# BON
BON_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "BON", "BON_flow_2025-02-03.csv"))[1:366,]
BON_flow_long <- flow_reformat(input_data = BON_flow, variable_name = "flow")

# ICH
ICH_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "ICH", "ICH_flow_2025-02-03.csv"))[1:366,]
ICH_flow_long <- flow_reformat(input_data = ICH_flow, variable_name = "flow")

# LGR
LGR_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "LGR", "LGR_flow_2025-02-03.csv"))[1:366,]
LGR_flow_long <- flow_reformat(input_data = LGR_flow, variable_name = "flow")

# MCN
MCN_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "MCN", "MCN_flow_2025-02-03.csv"))[1:366,]
MCN_flow_long <- flow_reformat(input_data = MCN_flow, variable_name = "flow")

# PRA
PRA_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "PRA", "PRA_flow_2025-02-03.csv"))[1:366,]
PRA_flow_long <- flow_reformat(input_data = PRA_flow, variable_name = "flow")

# RIS
RIS_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RIS", "RIS_flow_2025-02-03.csv"))[1:366,]
RIS_flow_long <- flow_reformat(input_data = RIS_flow, variable_name = "flow")

# RRE
RRE_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "RRE", "RRE_flow_2025-02-03.csv"))[1:366,]
RRE_flow_long <- flow_reformat(input_data = RRE_flow, variable_name = "flow")

# WEL
WEL_flow <- read.csv(here::here("Data", "covariate_data", "CBR_DART", "WEL", "WEL_flow_2025-02-03.csv"))[1:366,]
WEL_flow_long <- flow_reformat(input_data = WEL_flow, variable_name = "flow")

#### Join temperature, flow, and spill data ####

# create run year df
run_year <- c("04/05", "05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
              "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24", "24/25")
run_year_start <- seq(ymd_hms("2004-06-01 00:00:00"), ymd_hms("2024-06-01 00:00:00"), by = "years")
run_year_end <- seq(ymd_hms("2005-05-31 23:59:59"), ymd_hms("2025-05-31 23:59:59"), by = "years")
run_year_numeric = seq(4, 24, 1)

run_year_df <- data.frame(run_year, run_year_start, run_year_end, run_year_numeric)

# Here we will use the forebay temperature, because there's less missing data (although it doesn't actually matter that much)
BON_temp_mod %>% 
  left_join(dplyr::select(BON_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(BON_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> BON_cov

MCN_temp_mod %>% 
  left_join(dplyr::select(MCN_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(MCN_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> MCN_cov

PRA_temp_mod %>% 
  left_join(dplyr::select(PRA_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(PRA_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> PRA_cov

RIS_temp_mod %>% 
  left_join(dplyr::select(RIS_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(RIS_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> RIS_cov

RRE_temp_mod %>% 
  left_join(dplyr::select(RRE_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(RRE_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> RRE_cov

WEL_temp_mod %>% 
  left_join(dplyr::select(WEL_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(WEL_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> WEL_cov

ICH_temp_mod %>% 
  left_join(dplyr::select(ICH_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(ICH_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> ICH_cov

LGR_temp_mod %>% 
  left_join(dplyr::select(LGR_spill_long, spill, date), by = "date") %>% 
  left_join(dplyr::select(LGR_flow_long, flow, date), by = "date") %>% 
  mutate(date = ymd(date)) %>% 
  rowwise() %>%
  dplyr::mutate(run_year = subset(run_year_df, run_year_start <= date & run_year_end >= date)$run_year) -> LGR_cov

#### Visualize variation in covariate conditions ####

# to facilitate visual comparison, add plotting date to each dam's df
add_plotting_date <- function(data) {
  data %>% 
    mutate(month_day = format(as.Date(date), "%m-%d")) %>% 
    mutate(plotting_year = ifelse(month(date) < 6, 2000, 1999)) %>% 
    mutate(plotting_date = ymd(paste0(plotting_year, "-", month_day))) -> data
  return(data)
}

BON_cov <- add_plotting_date(BON_cov)
MCN_cov <- add_plotting_date(MCN_cov)
PRA_cov <- add_plotting_date(PRA_cov)
RIS_cov <- add_plotting_date(RIS_cov)
RRE_cov <- add_plotting_date(RRE_cov)
WEL_cov <- add_plotting_date(WEL_cov)
ICH_cov <- add_plotting_date(ICH_cov)
LGR_cov <- add_plotting_date(LGR_cov)



### summarize average conditions at each dam by run year in a big table ###
# temperature
BON_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(BON = mean(temp)) -> BON_temp_summary

MCN_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(MCN = mean(temp)) -> MCN_temp_summary

PRA_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(PRA = mean(temp)) -> PRA_temp_summary

RIS_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(RIS = mean(temp)) -> RIS_temp_summary

RRE_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(RRE = mean(temp)) -> RRE_temp_summary

WEL_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(WEL = mean(temp)) -> WEL_temp_summary

ICH_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(ICH = mean(temp)) -> ICH_temp_summary

LGR_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(LGR = mean(temp)) -> LGR_temp_summary


BON_temp_summary %>% 
  left_join(., MCN_temp_summary, by = "run_year") %>% 
  left_join(., PRA_temp_summary, by = "run_year") %>% 
  left_join(., RIS_temp_summary, by = "run_year") %>% 
  left_join(., RRE_temp_summary, by = "run_year") %>% 
  left_join(., WEL_temp_summary, by = "run_year") %>% 
  left_join(., ICH_temp_summary, by = "run_year") %>% 
  left_join(., LGR_temp_summary, by = "run_year") -> all_dams_temp_table



# spill volume
BON_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(BON = mean(spill)) -> BON_spill_summary

MCN_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(MCN = mean(spill)) -> MCN_spill_summary

PRA_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(PRA = mean(spill)) -> PRA_spill_summary

RIS_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(RIS = mean(spill)) -> RIS_spill_summary

RRE_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(RRE = mean(spill)) -> RRE_spill_summary

WEL_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(WEL = mean(spill)) -> WEL_spill_summary

ICH_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(ICH = mean(spill)) -> ICH_spill_summary

LGR_cov %>% 
  filter(!(run_year == "24/25")) %>% 
  group_by(run_year) %>% 
  summarise(LGR = mean(spill)) -> LGR_spill_summary

BON_spill_summary %>% 
  left_join(., MCN_spill_summary, by = "run_year") %>% 
  left_join(., PRA_spill_summary, by = "run_year") %>% 
  left_join(., RIS_spill_summary, by = "run_year") %>% 
  left_join(., RRE_spill_summary, by = "run_year") %>% 
  left_join(., WEL_spill_summary, by = "run_year") %>% 
  left_join(., ICH_spill_summary, by = "run_year") %>% 
  left_join(., LGR_spill_summary, by = "run_year") -> all_dams_spill_table

# spill days
data.frame(MCW_data$winter_spill_days_data[-1,] * 100) %>% 
  dplyr::select(-c(MOUTH, BON)) -> winter_spill_days_table

winter_spill_days_table$run_year <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")



### function to plot spill days, spill volume, and temperature at each dam ###
plot_covariates_one_dam <- function(data, dam_abbrev){
  
  temperature_plot <- ggplot(data, aes(x = plotting_date, y = temp, color = run_year)) +
  geom_line() +
    coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-05-31")), expand = FALSE) +
    xlab("Date") +
  ylab("Temperature") +
  # scale_x_date(date_breaks = "1 month", date_labels = "%b") +
      scale_x_date(date_breaks = "1 month", date_labels = c("Jan 1", "Feb 1", "Mar 1",
                                                        "Apr 1", "May 1", "Jun 1",
                                                        "Jul 1", "Aug 1", "Sep 1",
                                                        "Oct 1", "Nov 1", "Dec 1")) +
      scale_color_viridis_d(option = "turbo", guide = guide_legend(ncol = 2, title = "Run Year")) +
    theme(panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          # axis.title.y = element_blank(),
          # axis.text.y = element_blank(),
          # axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm"))


spill_volume_plot <- ggplot(data, aes(x = plotting_date, y = spill, color = run_year)) +
  geom_line() +
    coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-05-31"))) +
    xlab("Date") +
  ylab("Spill (kcfs)") +
  scale_y_continuous(expand = c(0, 0)) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b", expand = c(0,0)) +
  scale_color_viridis_d(option = "turbo", guide = guide_legend(ncol = 2, title = "Run Year")) +
    theme(panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          # axis.title.y = element_blank(),
          # axis.text.y = element_blank(),
          # axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm"))

as.data.frame(MCW_data$winter_spill_days_data[-1,]*100) %>% 
  dplyr::select(-c(MOUTH, BON)) %>% 
  rownames_to_column("index") -> winter_spill_days

winter_spill_days$run_year <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

winter_spill_days %>% 
  pivot_longer(cols = where(is.numeric), values_to = "Days", names_to = "Dam") %>% 
  mutate(index = as.numeric(index)) -> winter_spill_days_long

spill_days_plot <- ggplot(subset(winter_spill_days_long, Dam == dam_abbrev), aes(x = index, y = Days)) +
  geom_point() +
  xlab("Run Year") +
  ylab("Winter Spill Days") +
  scale_x_continuous(breaks = seq(2,20,2), labels = c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14", "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")[seq(1,19, 2)]) +
  scale_y_continuous(lim = c(0,85)) +
    theme(panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          # axis.title.y = element_blank(),
          # axis.text.y = element_blank(),
          # axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm"))

return(list(temperature_plot, spill_volume_plot, spill_days_plot))
  
}

BON_plots <- plot_covariates_one_dam(data = BON_cov, dam_abbrev = "BON")
MCN_plots <- plot_covariates_one_dam(data = MCN_cov, dam_abbrev = "MCN")
PRA_plots <- plot_covariates_one_dam(data = PRA_cov, dam_abbrev = "PRA")
RIS_plots <- plot_covariates_one_dam(data = RIS_cov, dam_abbrev = "RIS")
RRE_plots <- plot_covariates_one_dam(data = RRE_cov, dam_abbrev = "RRE")
WEL_plots <- plot_covariates_one_dam(data = WEL_cov, dam_abbrev = "WEL")
ICH_plots <- plot_covariates_one_dam(data = ICH_cov, dam_abbrev = "ICH")
LGR_plots <- plot_covariates_one_dam(data = LGR_cov, dam_abbrev = "LGR")


```

```{r generate_summary_tables}
all_dams_temp_table %>% 
  mutate(across(where(is.numeric), ~ round(., 2))) %>% 
  dplyr::rename("Run Year" = run_year) %>% 
  kbl(caption = "Mean temperature by run year across the dams in this study.") %>% 
  kable_styling(latex_options = "HOLD_position")

all_dams_spill_table %>% 
  mutate(across(where(is.numeric), ~ round(., 2))) %>% 
  dplyr::rename("Run Year" = run_year) %>% 
  kbl(caption = "Mean spill volume (kcfs) by run year across the dams in this study.") %>% 
  kable_styling(latex_options = "HOLD_position")

rownames(winter_spill_days_table) <- NULL
winter_spill_days_table %>% 
  relocate(run_year) %>% 
  dplyr::rename("Run Year" = run_year) %>% 
  kbl(caption = "Number of winter (January - March) spill days by run year across the dams in this study. Please note that Bonneville Dam is not included in this plot because it is not an overshoot dam for any populations in our study.") %>% 
  kable_styling(latex_options = "HOLD_position")


```


In the panels below, plots of temperature, spill volume, and number of winter spill days are shown for each of the mainstem dams in this study. Please note that because the temperature visualized here (and incorporated into the model) is an output from a MARSS model that estimated a single temperature state for the entire Columbia River Basin, all dams have the same trends in temperature, but with different overall magnitudes. The choice to model the entire basin as a single temperature trend was necessitated by significant gaps in data at some dams.


#### Bonneville Dam
```{r fig.dim = c(10,6)}
BON_plots[[1]]
BON_plots[[2]]
```

#### McNary Dam
```{r fig.dim = c(10,6)}
MCN_plots[[1]]
MCN_plots[[2]]
MCN_plots[[3]]
```

#### Priest Rapids Dam
```{r fig.dim = c(10,6)}
PRA_plots[[1]]
PRA_plots[[2]]
PRA_plots[[3]]
```

#### Rock Island Dam
```{r fig.dim = c(10,6)}
RIS_plots[[1]]
RIS_plots[[2]]
RIS_plots[[3]]
```

#### Rocky Reach Dam
```{r fig.dim = c(10,6)}
RRE_plots[[1]]
RRE_plots[[2]]
RRE_plots[[3]]
```

#### Wells Dam
```{r fig.dim = c(10,6)}
WEL_plots[[1]]
WEL_plots[[2]]
WEL_plots[[3]]
```

#### Ice Harbor Dam
```{r fig.dim = c(10,6)}
ICH_plots[[1]]
ICH_plots[[2]]
ICH_plots[[3]]
```

#### Lower Granite Dam
```{r fig.dim = c(10,6)}
LGR_plots[[1]]
LGR_plots[[2]]
LGR_plots[[3]]
```


### 3 Covariate correlations {.tabset .tabset-pills}

```{r}
#### Plot relationships ####
plot_spill_v_flow <- function(data, dam){
  plot <- ggplot(data, aes(x = flow, y = spill)) +
    geom_point() +
      theme(legend.position = "none",
          panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm")) +
    ylab("Spill (kcfs)") +
    xlab("Flow (kcfs)") +
    ggtitle(dam)
  
  return(plot)
}

plot_spill_v_temp <- function(data, dam){
  plot <- ggplot(data, aes(x = temp, y = spill)) +
    geom_point() +
      theme(legend.position = "none",
          panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm")) +
    ylab("Spill (kcfs)") +
    xlab(expression(~"Temperature" ~ ("C"))) +
    ggtitle(dam)
  
  return(plot)
}

```

#### All dams
```{r}
alldams_flow_spill_corr_table <- data.frame(Dam = c("Bonneville Dam", "McNary Dam", "Priest Rapids Dam", "Rock Island Dam",
                                                     "Rocky Reach Dam", "Wells Dam", "Ice Harbor Dam", "Lower Granite Dam"), 
                                            mean_flow = rep(NA, 8), mean_spill = rep(NA, 8))

# Bonneville Dam
BON_spill_flow_lm <- lm(spill~flow, data = BON_cov)
BON_spill_flow_lm_sum <- summary(BON_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[1] <- mean(BON_cov$flow)
alldams_flow_spill_corr_table$mean_spill[1] <- mean(BON_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[1] <- round(BON_spill_flow_lm_sum$adj.r.squared,2)

# McNary Dam
MCN_spill_flow_lm <- lm(spill~flow, data = MCN_cov)
MCN_spill_flow_lm_sum <- summary(MCN_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[2] <- mean(MCN_cov$flow)
alldams_flow_spill_corr_table$mean_spill[2] <- mean(MCN_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[2] <- round(MCN_spill_flow_lm_sum$adj.r.squared,2)

# Priest Rapids Dam
PRA_spill_flow_lm <- lm(spill~flow, data = PRA_cov)
PRA_spill_flow_lm_sum <- summary(PRA_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[3] <- mean(PRA_cov$flow)
alldams_flow_spill_corr_table$mean_spill[3] <- mean(PRA_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[3] <- round(PRA_spill_flow_lm_sum$adj.r.squared,2)

# Rock Island Dam
RIS_spill_flow_lm <- lm(spill~flow, data = RIS_cov)
RIS_spill_flow_lm_sum <- summary(RIS_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[4] <- mean(RIS_cov$flow)
alldams_flow_spill_corr_table$mean_spill[4] <- mean(RIS_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[4] <- round(RIS_spill_flow_lm_sum$adj.r.squared,2)

# Rocky Reach Dam
RRE_spill_flow_lm <- lm(spill~flow, data = RRE_cov)
RRE_spill_flow_lm_sum <- summary(RRE_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[5] <- mean(RRE_cov$flow)
alldams_flow_spill_corr_table$mean_spill[5] <- mean(RRE_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[5] <- round(RRE_spill_flow_lm_sum$adj.r.squared,2)

# Wells Dam
WEL_spill_flow_lm <- lm(spill~flow, data = WEL_cov)
WEL_spill_flow_lm_sum <- summary(WEL_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[6] <- mean(WEL_cov$flow)
alldams_flow_spill_corr_table$mean_spill[6] <- mean(WEL_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[6] <- round(WEL_spill_flow_lm_sum$adj.r.squared,2)

# Ice Harbor Dam
ICH_spill_flow_lm <- lm(spill~flow, data = ICH_cov)
ICH_spill_flow_lm_sum <- summary(ICH_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[7] <- mean(ICH_cov$flow)
alldams_flow_spill_corr_table$mean_spill[7] <- mean(ICH_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[7] <- round(ICH_spill_flow_lm_sum$adj.r.squared,2)

# Lower Granite Dam
LGR_spill_flow_lm <- lm(spill~flow, data = LGR_cov)
LGR_spill_flow_lm_sum <- summary(LGR_spill_flow_lm)

alldams_flow_spill_corr_table$mean_flow[8] <- mean(LGR_cov$flow)
alldams_flow_spill_corr_table$mean_spill[8] <- mean(LGR_cov$spill)
alldams_flow_spill_corr_table$`R-squared`[8] <- round(LGR_spill_flow_lm_sum$adj.r.squared,2)

alldams_flow_spill_corr_table %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill) %>% 
  kbl(caption = "Correlation between spill and flow across all run years in the dataset, by dam.") %>% 
  kable_styling(latex_options = "HOLD_position")
```

```{r}
alldams_temp_spill_corr_table <- data.frame(Dam = c("Bonneville Dam", "McNary Dam", "Priest Rapids Dam", "Rock Island Dam",
                                                    "Rocky Reach Dam", "Wells Dam", "Ice Harbor Dam", "Lower Granite Dam"), 
                                            mean_temp = rep(NA, 8), mean_spill = rep(NA, 8))

# Bonneville Dam
BON_spill_temp_lm <- lm(spill~temp, data = BON_cov)
BON_spill_temp_lm_sum <- summary(BON_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[1] <- mean(BON_cov$temp)
alldams_temp_spill_corr_table$mean_spill[1] <- mean(BON_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[1] <- round(BON_spill_temp_lm_sum$adj.r.squared,2)

# McNary Dam
MCN_spill_temp_lm <- lm(spill~temp, data = MCN_cov)
MCN_spill_temp_lm_sum <- summary(MCN_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[2] <- mean(MCN_cov$temp)
alldams_temp_spill_corr_table$mean_spill[2] <- mean(MCN_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[2] <- round(MCN_spill_temp_lm_sum$adj.r.squared,2)

# Priest Rapids Dam
PRA_spill_temp_lm <- lm(spill~temp, data = PRA_cov)
PRA_spill_temp_lm_sum <- summary(PRA_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[3] <- mean(PRA_cov$temp)
alldams_temp_spill_corr_table$mean_spill[3] <- mean(PRA_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[3] <- round(PRA_spill_temp_lm_sum$adj.r.squared,2)

# Rock Island Dam
RIS_spill_temp_lm <- lm(spill~temp, data = RIS_cov)
RIS_spill_temp_lm_sum <- summary(RIS_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[4] <- mean(RIS_cov$temp)
alldams_temp_spill_corr_table$mean_spill[4] <- mean(RIS_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[4] <- round(RIS_spill_temp_lm_sum$adj.r.squared,2)

# Rocky Reach Dam
RRE_spill_temp_lm <- lm(spill~temp, data = RRE_cov)
RRE_spill_temp_lm_sum <- summary(RRE_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[5] <- mean(RRE_cov$temp)
alldams_temp_spill_corr_table$mean_spill[5] <- mean(RRE_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[5] <- round(RRE_spill_temp_lm_sum$adj.r.squared,2)

# Wells Dam
WEL_spill_temp_lm <- lm(spill~temp, data = WEL_cov)
WEL_spill_temp_lm_sum <- summary(WEL_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[6] <- mean(WEL_cov$temp)
alldams_temp_spill_corr_table$mean_spill[6] <- mean(WEL_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[6] <- round(WEL_spill_temp_lm_sum$adj.r.squared,2)

# Ice Harbor Dam
ICH_spill_temp_lm <- lm(spill~temp, data = ICH_cov)
ICH_spill_temp_lm_sum <- summary(ICH_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[7] <- mean(ICH_cov$temp)
alldams_temp_spill_corr_table$mean_spill[7] <- mean(ICH_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[7] <- round(ICH_spill_temp_lm_sum$adj.r.squared,2)

# Lower Granite Dam
LGR_spill_temp_lm <- lm(spill~temp, data = LGR_cov)
LGR_spill_temp_lm_sum <- summary(LGR_spill_temp_lm)

alldams_temp_spill_corr_table$mean_temp[8] <- mean(LGR_cov$temp)
alldams_temp_spill_corr_table$mean_spill[8] <- mean(LGR_cov$spill)
alldams_temp_spill_corr_table$`R-squared`[8] <- round(LGR_spill_temp_lm_sum$adj.r.squared,2)

alldams_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean temp" = mean_temp,
                "Mean Spill" = mean_spill) %>% 
  kbl(caption = "Correlation between spill and temperature across all run years in the dataset, by dam.") %>% 
  kable_styling(latex_options = "HOLD_position")
```



#### Bonneville Dam

```{r}
plot_spill_v_flow(data = BON_cov, dam = "Bonneville Dam")
plot_spill_v_temp(data = BON_cov, dam = "Bonneville Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
              "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Bonnneville Dam
BON_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(BON_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # BON_cov_corr_table$covariate_1[i] <- "Flow"
  # BON_cov_corr_table$covariate_2[i] <- "Spill"
  BON_flow_spill_corr_table$mean_flow[i] <- mean(subset(BON_cov, run_year == run_years[i])$flow)
  BON_flow_spill_corr_table$mean_spill[i] <- mean(subset(BON_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  BON_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

BON_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(BON_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # BON_cov_corr_table$covariate_1[i] <- "Flow"
  # BON_cov_corr_table$covariate_2[i] <- "Spill"
  BON_temp_spill_corr_table$mean_temp[i] <- mean(subset(BON_cov, run_year == run_years[i])$temp)
  BON_temp_spill_corr_table$mean_spill[i] <- mean(subset(BON_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  BON_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

BON_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Bonneville Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

BON_temp_spill_corr_table %>% 
    mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Bonneville Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### McNary Dam

```{r}
plot_spill_v_flow(data = MCN_cov, dam = "McNary Dam")
plot_spill_v_temp(data = MCN_cov, dam = "McNary Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## McNary Dam
MCN_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(MCN_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # MCN_cov_corr_table$covariate_1[i] <- "Flow"
  # MCN_cov_corr_table$covariate_2[i] <- "Spill"
  MCN_flow_spill_corr_table$mean_flow[i] <- mean(subset(MCN_cov, run_year == run_years[i])$flow)
  MCN_flow_spill_corr_table$mean_spill[i] <- mean(subset(MCN_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  MCN_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

MCN_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(MCN_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # MCN_cov_corr_table$covariate_1[i] <- "Flow"
  # MCN_cov_corr_table$covariate_2[i] <- "Spill"
  MCN_temp_spill_corr_table$mean_temp[i] <- mean(subset(MCN_cov, run_year == run_years[i])$temp)
  MCN_temp_spill_corr_table$mean_spill[i] <- mean(subset(MCN_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  MCN_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

MCN_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for McNary Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

MCN_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for McNary Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Priest Rapids Dam

```{r}
plot_spill_v_flow(data = PRA_cov, dam = "Priest Rapids Dam")
plot_spill_v_temp(data = PRA_cov, dam = "Priest Rapids Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Priest Rapids Dam
PRA_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(PRA_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # PRA_cov_corr_table$covariate_1[i] <- "Flow"
  # PRA_cov_corr_table$covariate_2[i] <- "Spill"
  PRA_flow_spill_corr_table$mean_flow[i] <- mean(subset(PRA_cov, run_year == run_years[i])$flow)
  PRA_flow_spill_corr_table$mean_spill[i] <- mean(subset(PRA_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  PRA_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

PRA_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(PRA_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # PRA_cov_corr_table$covariate_1[i] <- "Flow"
  # PRA_cov_corr_table$covariate_2[i] <- "Spill"
  PRA_temp_spill_corr_table$mean_temp[i] <- mean(subset(PRA_cov, run_year == run_years[i])$temp)
  PRA_temp_spill_corr_table$mean_spill[i] <- mean(subset(PRA_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  PRA_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

PRA_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Priest Rapids Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

PRA_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Priest Rapids Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Rock Island Dam

```{r}
plot_spill_v_flow(data = RIS_cov, dam = "Rock Island Dam")
plot_spill_v_temp(data = RIS_cov, dam = "Rock Island Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Rock Island Dam
RIS_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(RIS_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # RIS_cov_corr_table$covariate_1[i] <- "Flow"
  # RIS_cov_corr_table$covariate_2[i] <- "Spill"
  RIS_flow_spill_corr_table$mean_flow[i] <- mean(subset(RIS_cov, run_year == run_years[i])$flow)
  RIS_flow_spill_corr_table$mean_spill[i] <- mean(subset(RIS_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  RIS_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

RIS_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(RIS_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # RIS_cov_corr_table$covariate_1[i] <- "Flow"
  # RIS_cov_corr_table$covariate_2[i] <- "Spill"
  RIS_temp_spill_corr_table$mean_temp[i] <- mean(subset(RIS_cov, run_year == run_years[i])$temp)
  RIS_temp_spill_corr_table$mean_spill[i] <- mean(subset(RIS_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  RIS_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

RIS_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Rock Island Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

RIS_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Rock Island Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Rocky Reach Dam

```{r}
plot_spill_v_flow(data = RRE_cov, dam = "Rocky Reach Dam")
plot_spill_v_temp(data = RRE_cov, dam = "Rocky Reach Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Rocky Reach Dam
RRE_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(RRE_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # RRE_cov_corr_table$covariate_1[i] <- "Flow"
  # RRE_cov_corr_table$covariate_2[i] <- "Spill"
  RRE_flow_spill_corr_table$mean_flow[i] <- mean(subset(RRE_cov, run_year == run_years[i])$flow)
  RRE_flow_spill_corr_table$mean_spill[i] <- mean(subset(RRE_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  RRE_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

RRE_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(RRE_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # RRE_cov_corr_table$covariate_1[i] <- "Flow"
  # RRE_cov_corr_table$covariate_2[i] <- "Spill"
  RRE_temp_spill_corr_table$mean_temp[i] <- mean(subset(RRE_cov, run_year == run_years[i])$temp)
  RRE_temp_spill_corr_table$mean_spill[i] <- mean(subset(RRE_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  RRE_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

RRE_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Rocky Reach Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

RRE_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Rocky Reach Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Wells Dam

```{r}
plot_spill_v_flow(data = WEL_cov, dam = "Wells Dam")
plot_spill_v_temp(data = WEL_cov, dam = "Wells Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Wells Dam
WEL_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(WEL_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # WEL_cov_corr_table$covariate_1[i] <- "Flow"
  # WEL_cov_corr_table$covariate_2[i] <- "Spill"
  WEL_flow_spill_corr_table$mean_flow[i] <- mean(subset(WEL_cov, run_year == run_years[i])$flow)
  WEL_flow_spill_corr_table$mean_spill[i] <- mean(subset(WEL_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  WEL_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

WEL_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(WEL_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # WEL_cov_corr_table$covariate_1[i] <- "Flow"
  # WEL_cov_corr_table$covariate_2[i] <- "Spill"
  WEL_temp_spill_corr_table$mean_temp[i] <- mean(subset(WEL_cov, run_year == run_years[i])$temp)
  WEL_temp_spill_corr_table$mean_spill[i] <- mean(subset(WEL_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  WEL_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

WEL_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Wells Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

WEL_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Wells Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Ice Harbor Dam

```{r}
plot_spill_v_flow(data = ICH_cov, dam = "Ice Harbor Dam")
plot_spill_v_temp(data = ICH_cov, dam = "Ice Harbor Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Ice Harbor Dam
ICH_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(ICH_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # ICH_cov_corr_table$covariate_1[i] <- "Flow"
  # ICH_cov_corr_table$covariate_2[i] <- "Spill"
  ICH_flow_spill_corr_table$mean_flow[i] <- mean(subset(ICH_cov, run_year == run_years[i])$flow)
  ICH_flow_spill_corr_table$mean_spill[i] <- mean(subset(ICH_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  ICH_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

ICH_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(ICH_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # ICH_cov_corr_table$covariate_1[i] <- "Flow"
  # ICH_cov_corr_table$covariate_2[i] <- "Spill"
  ICH_temp_spill_corr_table$mean_temp[i] <- mean(subset(ICH_cov, run_year == run_years[i])$temp)
  ICH_temp_spill_corr_table$mean_spill[i] <- mean(subset(ICH_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  ICH_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

ICH_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Ice Harbor Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

ICH_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Ice Harbor Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```

#### Lower Granite Dam

```{r}
plot_spill_v_flow(data = LGR_cov, dam = "Lower Granite Dam")
plot_spill_v_temp(data = LGR_cov, dam = "Lower Granite Dam")

#### Create a table of correlations, by year by dam ####
run_years <- c("05/06", "06/07", "07/08", "08/09", "09/10", "10/11", "11/12", "12/13", "13/14",
               "14/15", "15/16", "16/17", "17/18", "18/19", "19/20", "20/21","21/22", "22/23", "23/24")

## Lower Granite Dam
LGR_flow_spill_corr_table <- data.frame(run_year = run_years, mean_flow = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_flow_lm <- lm(spill~flow, data = subset(LGR_cov, run_year == run_years[i]))
  spill_flow_lm_sum <- summary(spill_flow_lm)
  # LGR_cov_corr_table$covariate_1[i] <- "Flow"
  # LGR_cov_corr_table$covariate_2[i] <- "Spill"
  LGR_flow_spill_corr_table$mean_flow[i] <- mean(subset(LGR_cov, run_year == run_years[i])$flow)
  LGR_flow_spill_corr_table$mean_spill[i] <- mean(subset(LGR_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  LGR_flow_spill_corr_table$`R-squared`[i] <- round(spill_flow_lm_sum$adj.r.squared,2)
}

LGR_temp_spill_corr_table <- data.frame(run_year = run_years, mean_temp = rep(NA, 19), mean_spill = rep(NA, 19))
for (i in 1:length(run_years)){
  spill_temp_lm <- lm(spill~temp, data = subset(LGR_cov, run_year == run_years[i]))
  spill_temp_lm_sum <- summary(spill_temp_lm)
  # LGR_cov_corr_table$covariate_1[i] <- "Flow"
  # LGR_cov_corr_table$covariate_2[i] <- "Spill"
  LGR_temp_spill_corr_table$mean_temp[i] <- mean(subset(LGR_cov, run_year == run_years[i])$temp)
  LGR_temp_spill_corr_table$mean_spill[i] <- mean(subset(LGR_cov, run_year == run_years[i])$spill)
  # store adjusted R-squared in table
  LGR_temp_spill_corr_table$`R-squared`[i] <- round(spill_temp_lm_sum$adj.r.squared,2)
}

LGR_flow_spill_corr_table  %>% 
  mutate(mean_flow = round(mean_flow, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Flow" = mean_flow,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and flow for each year, for Lower Granite Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

LGR_temp_spill_corr_table %>% 
  mutate(mean_temp = round(mean_temp, 2),
         mean_spill = round(mean_spill, 2)) %>% 
  dplyr::rename("Mean Temperature" = mean_temp,
                "Mean Spill" = mean_spill,
                "Run Year" = run_year) %>% 
  kbl(caption = "Correlation between spill and temperature for each year, for Lower Granite Dam") %>% 
  kable_styling(latex_options = "HOLD_position")

```


### 4 Post-overshoot fallback timing {.tabset .tabset-pills}

These figures show the timing of observations of overshoot (first point) and first observation following post-overshoot fallback (second point) for each fish from a given population. Red points indicate terminal overshoot observations (where fish were not seen again below an overshoot dam following overshoot). Lines connecting overshoot observations with post-overshoot fallback observations indicate that time period in which a fallback event must have occurred. Dashed green lines indicate the winter months (January, February, and March) that were used to characterize the likely spill conditions encountered by fish in overshoot states. In our model, any fish that was last observed overshooting (red dots) or where based on their detection history, may have fallen back during January, February, or March (any black lines that are at least partially between the two dashed green lines) are affected by the winter spill days covariate.

```{r define_S1_functions}
# add DPS info to origin_param_map
origin_param_map$DPS <- c(rep("Middle Columbia", 6),
                          rep("Upper Columbia", 4),
                          rep("Snake River", 6),
                          rep(NA, 3))


# Here, we need to plot when fish are arriving back in natal tributaries after overshoot

# Define a function that extracts the data and formats it for a plot
plot_overshoot_fallback_timing <- function(data, natal_origin_select, DPS_select, rear_select){
  #### Create a large DF that notes which states are overshoot states ####
  DES_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "loss"))]
  
  JDR_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "loss"))]
  
  FIF_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "loss"))]
  
  UMA_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "loss"))]
  
    YAK_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "mainstem, MCN to ICH or PRA", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "Yakima River Mouth",            
                                          "Yakima River Upstream",
                                          "Walla Walla River Mouth",
                                          "Walla Walla River Upstream",
                                          "loss"))]
    
    WAWA_overshoot_states <- model_states[!(model_states %in% c("mainstem, mouth to BON",
                                          "mainstem, BON to MCN", 
                                          "mainstem, MCN to ICH or PRA", 
                                          "Deschutes River Mouth",
                                          "Deschutes River Upstream",
                                          "John Day River Mouth",          
                                          "John Day River Upstream",
                                          "Fifteenmile Creek Mouth",
                                          "Fifteenmile Creek Upstream",
                                          "Umatilla River Mouth",
                                          "Umatilla River Upstream",
                                          "BON to MCN other tributaries",
                                          "Yakima River Mouth",            
                                          "Yakima River Upstream",
                                          "Walla Walla River Mouth",
                                          "Walla Walla River Upstream",
                                          "loss"))]
  
  WEN_overshoot_states <- c("mainstem, RRE to WEL", "mainstem, upstream of WEL",
                                         "Entiat River Mouth", "Entiat River Upstream",
                                         "Methow River Mouth", "Methow River Upstream",
                                         "Okanogan River Mouth", "Okanogan River Upstream",
                                         "Upstream WEL other tributaries")
  
  ENT_overshoot_states <- c("mainstem, upstream of WEL",
                                         "Methow River Mouth", "Methow River Upstream",
                                         "Okanogan River Mouth", "Okanogan River Upstream",
                                         "Upstream WEL other tributaries")
  
  TUC_overshoot_states <- c("mainstem, upstream of LGR",
                            "Asotin Creek Mouth",
                            "Asotin Creek Upstream",
                            "Clearwater River",
                            "Salmon River",
                            "Grande Ronde River",
                            "Imnaha River Mouth",
                            "Imnaha River Upstream")
  
overshoot_states <- data.frame(natal_origin = c(rep("Deschutes River", length(DES_overshoot_states)),
                                                rep("John Day River", length(JDR_overshoot_states)),
                                                rep("Fifteenmile Creek", length(FIF_overshoot_states)),
                                                rep("Umatilla River", length(UMA_overshoot_states)),
                                                rep("Yakima River", length(YAK_overshoot_states)),
                                                rep("Walla Walla River", length(WAWA_overshoot_states)),
                                                rep("Wenatchee River", length(WEN_overshoot_states)),
                                                rep("Entiat River", length(ENT_overshoot_states)),
                                                rep("Tucannon River", length(TUC_overshoot_states))),
                               state = c(DES_overshoot_states,
                                         JDR_overshoot_states,
                                         FIF_overshoot_states,
                                         UMA_overshoot_states,
                                         YAK_overshoot_states,
                                         WAWA_overshoot_states,
                                         WEN_overshoot_states,
                                         ENT_overshoot_states,
                                         TUC_overshoot_states))

overshoot_states$state_number <- NA 

for (i in 1:nrow(overshoot_states)){
  overshoot_states$state_number[i] <- which(model_states == overshoot_states$state[i])
}

  #### reformat data ####
  # get origin
origin_vector <- vector(length = nrow(data$cat_X_mat))
for(i in 1:nrow(data$cat_X_mat)){
  origin_vector[i] <- which(data$cat_X_mat[i,]==1)
}

# get dates of state visits
transition_dates <- as.data.frame(data$transition_dates)
colnames(transition_dates) <- 1:ncol(transition_dates)
# add origin info
transition_dates$origin <- origin_vector
transition_dates %>% 
  mutate(fish_ID = row_number()) %>% 
  pivot_longer(cols = -c(fish_ID, origin), names_to = "state_history", values_to = "model_date") -> transition_dates

# add the actual dates
dates_actual <- data.frame(date_actual = seq(ymd("2005-06-01"), ymd("2024-12-31"), by = "days"),
                           model_date = 1:length(seq(ymd("2005-06-01"), ymd("2024-12-31"), by = "days")))
dates_actual %>% 
  mutate(month_day = format(as.Date(date_actual), "%m-%d")) -> dates_actual

transition_dates %>% 
  left_join(., dates_actual, by = "model_date") -> transition_dates

# get state visits
state_visits <- as.data.frame(data$y)
colnames(state_visits) <- 1:ncol(state_visits)
# add origin info
state_visits$origin <- origin_vector

state_visits %>% 
  mutate(fish_ID = row_number()) %>% 
  pivot_longer(cols = -c(fish_ID, origin), names_to = "state_history", values_to = "state") -> state_visits

# join state visits with transition dates
transition_dates$state <- state_visits$state

# keep only actual data
transition_dates %>% 
  filter(state != 0) -> transition_histories

# join with origin_param_map
if(rear_select == "wild"){
  transition_histories %>% 
  left_join(filter(dplyr::select(origin_param_map, natal_origin, wild), 
                   natal_origin %in% subset(origin_param_map, DPS == DPS_select)$natal_origin), 
            join_by(origin==wild)) -> transition_histories
} else{
  transition_histories %>% 
  left_join(filter(dplyr::select(origin_param_map, natal_origin, hatchery), 
                   natal_origin %in% subset(origin_param_map, DPS == DPS_select)$natal_origin), 
            join_by(origin==hatchery)) -> transition_histories
}

# Note when fish are in an overshoot state
transition_histories %>%
  mutate(overshoot = ifelse(natal_origin == natal_origin_select & state %in% subset(overshoot_states, natal_origin == natal_origin_select)$state_number,
                            "overshoot", "not overshoot")) -> transition_histories
  
subset(transition_histories, natal_origin == natal_origin_select) -> origin_data

origin_data %>% 
  group_by(fish_ID) %>% 
  filter(any(overshoot == "overshoot")) -> origin_overshoots

# figure out what day overshoot begins, and what day it ends
origin_overshoots %>% 
  group_by(fish_ID) %>% 
  filter(overshoot == "overshoot") %>% 
  filter(!(duplicated(fish_ID))) -> origin_first_overshoot

origin_overshoots %>% 
  mutate(end_overshoot = ifelse(lag(overshoot) == "overshoot" & overshoot == "not overshoot", "end overshoot", "not end overshoot")) -> origin_overshoots

origin_overshoots %>% 
  filter(overshoot == "overshoot" | end_overshoot == "end overshoot") -> origin_overshoot_history

# here, we need to pull when they were seen after falling back (first not overshoot state timing),
# and when they were last seen previous to falling back (this is the last overshoot state where
# the date isn't the same)
# origin_overshoot_history %>%
#   # this drops any overshoot states that are implicit movements (and therefore,
#   # the dates aren't useful)
#   filter(overshoot == "not overshoot" & lag(overshoot) == "overshoot" |
#            overshoot == "overshoot" & date_actual != lead(date_actual) |
#            overshoot == "overshoot" & lead(state) == 41) %>%
#   # this now keeps only the observation directly before the fallback detection
#     filter(overshoot == "not overshoot" & lag(overshoot) == "overshoot" |
#            overshoot == "overshoot" & lead(overshoot) == "not overshoot") -> origin_end_overshoot_history


# Identify the last overshoot event and then the first time after fallback
origin_overshoot_history %>%
  # this drops any overshoot states that are implicit movements (and therefore,
  # the dates aren't useful)
  filter(overshoot == "not overshoot" & lag(overshoot) == "overshoot" |
           overshoot == "overshoot" & date_actual != lead(date_actual) |
           overshoot == "overshoot" & lead(state) == 41) %>% 
  # drop any movements that aren't preceded by a mainstem overshoot
  filter(overshoot == "overshoot" | lag(overshoot == "overshoot") & state %in% c(1:9)) -> origin_end_overshoot_history

# now divide this up so that we can plot each overshoot movement and the next detection
origin_end_overshoot_history %>% 
  mutate(overshoot_start_date = if_else(overshoot == "overshoot" & state %in% 1:9, date_actual, as.Date(NA))) %>% 
  mutate(overshoot_start_month_day = format(as.Date(overshoot_start_date), "%m-%d")) %>% 
  mutate(overshoot_end_date = if_else(overshoot == "overshoot" & state %in% 1:9, lead(date_actual), as.Date(NA))) %>% 
  mutate(overshoot_end_month_day = format(as.Date(overshoot_end_date), "%m-%d")) -> origin_end_overshoot_history

# make the dates revolve around the run_year
origin_end_overshoot_history %>% 
  mutate(plotting_overshoot_start_date_year = ifelse(month(overshoot_start_date) < 6, 2000, 1999)) %>% 
  mutate(plotting_overshoot_start_date = ymd(paste0(plotting_overshoot_start_date_year, "-", overshoot_start_month_day))) %>% 
  mutate(plotting_overshoot_end_date_year = ifelse(month(overshoot_end_date) < 6, 2000, 1999)) %>% 
  mutate(plotting_overshoot_end_date = ymd(paste0(plotting_overshoot_end_date_year, "-", overshoot_end_month_day))) -> origin_end_overshoot_history

# re-assign IDs
origin_end_overshoot_history %>% 
  ungroup() %>% 
  mutate(ID_new = row_number()) -> origin_end_overshoot_history



# figure out which fish we don't see again
origin_end_overshoot_history %>% 
  filter(!(is.na(overshoot_start_date)) & is.na(overshoot_end_date)) -> origin_overshoot_loss

# origin_end_overshoot_history %>% 
#   group_by(fish_ID) %>% 
#   filter(lead(state) == 41) -> origin_overshoot_loss
# 
# origin_end_overshoot_history %>% 
#   group_by(fish_ID) %>% 
#   filter(lead(state) == 41 | state == 41) -> origin_overshoot_loss
# 
# add a fake date to indicate that we don't know when this could end
# origin_overshoot_loss %>%
#   mutate(plotting_date = if_else(is.na(plotting_date), ymd("2000-05-31"), ymd(plotting_date))) -> origin_overshoot_loss
origin_overshoot_loss %>%
  mutate(plotting_overshoot_end_date = if_else(is.na(plotting_overshoot_end_date), ymd("2000-05-31"), ymd(plotting_overshoot_end_date))) -> origin_overshoot_loss

overshoot_fallback_timing_plot <- ggplot(origin_end_overshoot_history, aes(y = ID_new)) +
  # geom_line(aes(group = ID_new), linewidth = 0.25) +
  geom_segment(aes(x = plotting_overshoot_start_date, xend = plotting_overshoot_end_date, y = ID_new, yend = ID_new)) +
  geom_point(aes(x = plotting_overshoot_start_date, y = ID_new)) +
  geom_point(aes(x = plotting_overshoot_end_date, y = ID_new)) +
  geom_point(data = origin_overshoot_loss, aes(x = plotting_overshoot_start_date, y = ID_new), color = "red") + # this places a red dot on top of any start overshoot dates that aren't followed by a subsequent post-fallback detection
  # geom_line(data = origin_overshoot_loss, aes(group = ID_new, x = plotting_date, y = ID_new), color = "red") +
  geom_vline(xintercept = ymd("2000-01-01"), lty = 2, color = "#2ca25f") +
  geom_vline(xintercept = ymd("2000-03-31"), lty = 2, color = "#2ca25f") +
  coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-05-31")), 
                  ylim = c(0, max(origin_end_overshoot_history$ID_new)+1), expand = FALSE) +
    xlab("Date") +
  # scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    scale_x_date(date_breaks = "1 month", date_labels = c("Jan 1", "Feb 1", "Mar 1",
                                                        "Apr 1", "May 1", "Jun 1",
                                                        "Jul 1", "Aug 1", "Sep 1",
                                                        "Oct 1", "Nov 1", "Dec 1")) +
    theme(legend.position = "none",
          panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          axis.title.y = element_blank(),
          axis.text.y = element_blank(),
          axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm")) +
  ggtitle(paste0(natal_origin_select, ", ", ifelse(rear_select == "wild", "natural", rear_select)))

#### summarize timing of post-overshoot fallback timing ####
origin_end_overshoot_history %>% 
  mutate(jan_mar_window = ifelse(ymd("2000-01-01") >= plotting_overshoot_start_date & ymd("2000-01-01") <= plotting_overshoot_end_date | 
                                   ymd("2000-03-31") >= plotting_overshoot_start_date & ymd("2000-03-31") <= plotting_overshoot_end_date, 1, 0)) %>% 
  filter(!is.na(overshoot_start_date)) %>% 
  mutate(jan_mar_window = ifelse(is.na(overshoot_end_date) & plotting_overshoot_start_date <= ymd("2000-03-31"), 1, jan_mar_window)) -> origin_end_overshoot_history

as.data.frame(table(origin_end_overshoot_history$jan_mar_window)) %>% 
  dplyr::rename(jan_mar_window = Var1) %>% 
  mutate(population = paste(natal_origin_select, rear_select)) %>% 
  mutate(population = gsub("wild", "natural", population)) -> jan_mar_window_table
  

#### plot post-overshoot fallback timing ####

# create df to store fallback dam combos
fallback_dams_df <- data.frame(fallback_state = c(2,3,4,5,6,3,8),
                               overshoot_state = c(3,4,5,6,7,8,9))

# identify fallback movements
origin_overshoots %>% 
  left_join(fallback_dams_df, by = join_by(state == overshoot_state)) %>% 
  mutate(fallback = ifelse(fish_ID == lag(fish_ID) & lag(overshoot) == "overshoot" & lag(fallback_state) == state, 1, 0)) %>% 
  # make sure that we don't double count implicit fallbacks
  filter(!(model_date == lag(model_date) & fish_ID == lag(fish_ID) & fallback == 1)) %>% 
  filter(fallback == 1) %>% 
  mutate(plotting_year = ifelse(month(date_actual) < 6, 2000, 1999)) %>% 
  mutate(plotting_date = ymd(paste0(plotting_year, "-", month_day))) %>% 
  mutate(population = paste(natal_origin_select, rear_select)) %>% 
  mutate(population = gsub("wild", "natural", population)) -> known_fallback_timing

fallback_timing_plot <- ggplot(known_fallback_timing, aes(x = plotting_date)) +
  geom_histogram() +
    coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-05-31")), expand = FALSE) +
    xlab("Date") +
  # scale_x_date(date_breaks = "1 month", date_labels = "%b") +
    scale_x_date(date_breaks = "1 month", date_labels = c("Jan 1", "Feb 1", "Mar 1",
                                                        "Apr 1", "May 1", "Jun 1",
                                                        "Jul 1", "Aug 1", "Sep 1",
                                                        "Oct 1", "Nov 1", "Dec 1")) +
    theme(legend.position = "none",
          panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          # axis.title.y = element_blank(),
          # axis.text.y = element_blank(),
          # axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm")) +
  ggtitle(paste0(natal_origin_select, ", ", ifelse(rear_select == "wild", "natural", rear_select)))


return(list(overshoot_fallback_timing_plot, jan_mar_window_table, fallback_timing_plot, known_fallback_timing))

# origin_end_overshoot_history %>% 
#   mutate(movement = ifelse(overshoot == "overshoot", "overshoot",
#                            ifelse(overshoot == "not overshoot", "fallback", NA))) %>% 
#   mutate(plotting_date = if_else(is.na(plotting_date), ymd("2000-07-01"), plotting_date)) -> fallback_overshoot_count_data
# 
# 
# overshoot_fallback_timing_histogram <- ggplot(fallback_overshoot_count_data, aes(x = plotting_date, fill = movement)) +
#   geom_histogram() +
#   geom_vline(xintercept = ymd("2000-01-01"), lty = 2, color = "#2ca25f") +
#   geom_vline(xintercept = ymd("2000-03-31"), lty = 2, color = "#2ca25f") +
#   coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-07-31")), 
#                   expand = FALSE) +
#     xlab("Date") +
#   # scale_x_date(date_breaks = "1 month") +
#   # scale_x_date(date_breaks = "1 month", date_labels = "%b") +
#   scale_x_date(date_breaks = "1 month", labels = c("Jun", "Jul", "Aug", "Sep",
#                                                    "Oct", "Nov", "Dec", "Jan",
#                                                    "Feb", "Mar", "Apr", "May",
#                                                    "Jun", "NA", "NA")) +
#     theme(panel.grid.major = element_line(color = "gray90"),
#           panel.background = element_rect(fill = "white", color = "black"),
#           panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
#           plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm")) +
#   ggtitle(paste0(natal_origin_select, ", ", rear_select))

# return(list(overshoot_fallback_timing_plot, overshoot_fallback_timing_histogram))
}

# check that post overshoot was correctly assigned
# subset(origin_data, fish_ID == 1105)
# subset(state_visits, !(state %in% c(0, 41))) -> state_visits_noloss
# state_visits_noloss$winter_post_overshoot <- MCW_data$winter_post_overshoot_vector
# subset(state_visits_noloss, fish_ID == 1105)

# subset(origin_data, fish_ID == "5119")
```


```{r generate_S1, fig.dim = c(6,12)}
DES_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "Deschutes River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

JDR_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "John Day River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

FIF_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "Fifteenmile Creek", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

UMA_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "Umatilla River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

UMA_H_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCH_data, 
                               natal_origin_select = "Umatilla River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "hatchery")

YAK_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "Yakima River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

WAWA_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCW_data, 
                               natal_origin_select = "Walla Walla River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "wild")

WAWA_H_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = MCH_data, 
                               natal_origin_select = "Walla Walla River", 
                               DPS_select = "Middle Columbia", 
                               rear_select = "hatchery")

ENT_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = UCW_data, 
                               natal_origin_select = "Entiat River", 
                               DPS_select = "Upper Columbia", 
                               rear_select = "wild")

WEN_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = UCW_data, 
                               natal_origin_select = "Wenatchee River", 
                               DPS_select = "Upper Columbia", 
                               rear_select = "wild")

WEN_H_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = UCH_data, 
                               natal_origin_select = "Wenatchee River", 
                               DPS_select = "Upper Columbia", 
                               rear_select = "hatchery")

TUC_W_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = SRW_data, 
                               natal_origin_select = "Tucannon River", 
                               DPS_select = "Snake River", 
                               rear_select = "wild")

TUC_H_overshoot_fallback_timing_plot <- plot_overshoot_fallback_timing(data = SRH_data, 
                               natal_origin_select = "Tucannon River", 
                               DPS_select = "Snake River", 
                               rear_select = "hatchery")
```


```{r fallback_timing_all_origin_summaries, fig.dim = c(8,8)}

# create a summary table of jan mar window
DES_W_overshoot_fallback_timing_plot[[2]] %>% 
  bind_rows(JDR_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(FIF_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(UMA_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(UMA_H_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(YAK_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(WAWA_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(WAWA_H_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(ENT_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(WEN_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(WEN_H_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(TUC_W_overshoot_fallback_timing_plot[[2]]) %>% 
  bind_rows(TUC_H_overshoot_fallback_timing_plot[[2]]) %>% 
  mutate(jan_mar_window = as.numeric(jan_mar_window)-1) %>% 
  pivot_wider(names_from = jan_mar_window, values_from = Freq) %>% 
  dplyr::rename(in_window = `1`, outside_window = `0`) %>% 
  mutate(total = in_window + outside_window) %>% 
  mutate(proportion = in_window/total) %>% 
  dplyr::select(-outside_window) -> jan_mar_window_table

jan_mar_window_table %>% 
  mutate(proportion = round(proportion, 2)) %>% 
  kbl(caption = "Proportion of overshoot state visits that received the January-March spill days covariate.") %>% 
  kable_styling(latex_options = "HOLD_position")

DES_W_overshoot_fallback_timing_plot[[4]] %>% 
  bind_rows(JDR_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(FIF_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(UMA_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(UMA_H_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(YAK_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(WAWA_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(WAWA_H_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(ENT_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(WEN_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(WEN_H_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(TUC_W_overshoot_fallback_timing_plot[[4]]) %>% 
  bind_rows(TUC_H_overshoot_fallback_timing_plot[[4]])  -> known_fallback_timing_all_origins

ggplot(known_fallback_timing_all_origins, aes(x = plotting_date, fill = population)) +
  geom_histogram() +
    coord_cartesian(xlim = c(ymd("1999-06-01"), ymd("2000-05-31")), expand = FALSE) +
    xlab("Date") +
  # scale_x_date(date_breaks = "1 month", date_labels = "%b") +
  scale_x_date(date_breaks = "1 month", date_labels = c("Jan 1", "Feb 1", "Mar 1",
                                                        "Apr 1", "May 1", "Jun 1",
                                                        "Jul 1", "Aug 1", "Sep 1",
                                                        "Oct 1", "Nov 1", "Dec 1")) +
  scale_fill_tableau(palette = "Tableau 20") +
    theme(panel.grid.major = element_line(color = "gray90"),
          panel.background = element_rect(fill = "white", color = "black"),
          panel.border = element_rect(colour = "black", fill=NA, linewidth=0.4),
          # axis.title.y = element_blank(),
          # axis.text.y = element_blank(),
          # axis.ticks.y = element_blank(),
          plot.margin = unit(c(0.2, 0.2, 0.2, 0.2),"cm"))

```

#### Deschutes (N)
```{r fig.dim = c(6,10)}
DES_W_overshoot_fallback_timing_plot[[1]]
DES_W_overshoot_fallback_timing_plot[[3]]
```

#### John Day (N)
```{r fig.dim = c(6,10)}
JDR_W_overshoot_fallback_timing_plot[[1]]
JDR_W_overshoot_fallback_timing_plot[[3]]
```

#### Fifteenmile (N)
```{r fig.dim = c(6,10)}
FIF_W_overshoot_fallback_timing_plot[[1]]
FIF_W_overshoot_fallback_timing_plot[[3]]
```

#### Umatilla (N)
```{r fig.dim = c(6,10)}
UMA_W_overshoot_fallback_timing_plot[[1]]
UMA_W_overshoot_fallback_timing_plot[[3]]
```

#### Umatilla (H)
```{r fig.dim = c(6,10)}
UMA_H_overshoot_fallback_timing_plot[[1]]
UMA_H_overshoot_fallback_timing_plot[[3]]
```

#### Yakima (N)
```{r fig.dim = c(6,10)}
YAK_W_overshoot_fallback_timing_plot[[1]]
YAK_W_overshoot_fallback_timing_plot[[3]]
```

#### Walla Walla (N)
```{r fig.dim = c(6,10)}
WAWA_W_overshoot_fallback_timing_plot[[1]]
WAWA_W_overshoot_fallback_timing_plot[[3]]
```

#### Walla Walla (H)
```{r fig.dim = c(6,10)}
WAWA_H_overshoot_fallback_timing_plot[[1]]
WAWA_H_overshoot_fallback_timing_plot[[3]]
```

#### Entiat (N)
```{r fig.dim = c(6,10)}
ENT_W_overshoot_fallback_timing_plot[[1]]
ENT_W_overshoot_fallback_timing_plot[[3]]
```

#### Wenatchee (N)
```{r fig.dim = c(6,10)}
WEN_W_overshoot_fallback_timing_plot[[1]]
WEN_W_overshoot_fallback_timing_plot[[3]]
```

#### Wenatchee (H)
```{r fig.dim = c(6,10)}
WEN_H_overshoot_fallback_timing_plot[[1]]
WEN_H_overshoot_fallback_timing_plot[[3]]
```

#### Tucannon (N)
```{r fig.dim = c(6,10)}
TUC_W_overshoot_fallback_timing_plot[[1]]
TUC_W_overshoot_fallback_timing_plot[[3]]
```

#### Tucannon (H)
```{r fig.dim = c(6,10)}
TUC_H_overshoot_fallback_timing_plot[[1]]
TUC_H_overshoot_fallback_timing_plot[[3]]
```






### 5 Detection efficiency estimation {.tabset .tabset-pills}


The figures below show the estimated relationship between discharge and detection efficiency at the river mouth sites for different tributaries in different site configurations. A priori, our hypothesis was that detection efficiency would generally decrease as discharge increases, as increased flow would increase the area that is outside the detection range of the PIT tag arrays. However, as seen below, for some tributaries we estimated a positive relationship between discharge and detection efficiency. There are two possible explanations for this estimated relationship. First, changes to the PIT-tag antenna configurations or operations that were not captured in our site configuration covariate in the detection level efficiency estimation could be obscuring the true relationship. While we attempted to capture major changes, an inspection of the operational history and event log summary at each site on the [PTAGIS Interrogation Site Metadata](https://www.ptagis.org/Sites/InterrogationSites) reveals numerous events (e.g., battery failures, flood damage, equipment failures and repairs) that may have affected the detection efficiency and confounded the relationship with discharge. Second, there are reasons that higher discharge may actually be favorable for detection efficiency. For example, PIT tag arrays are known to perform poorly in cases where two or more fish pass over the antenna at the same time [@Greenberg2000], which may be more likely when flows are low. Furthermore, fish behavior can change with changing stream conditions, and the ability of PIT tag interrogation systems to detect fish can change with conditions that are affected by flow, including water temperature, conductivity, and air temperature [@Connolly2009].



#### Fifteenmile Creek
![Fifteenmile Creek, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/fifteenmile_fitted_DE_plot_era1.png){width=100%}


#### Deschutes River
![Deschutes River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/deschutes_fitted_DE_plot_era1.png){width=100%}

#### John Day River
![John Day River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/john_day_fitted_DE_plot_era1.png){width=100%}

#### Umatilla River
![Umatilla River, estimated detection efficiency in time period 1.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/umatilla_fitted_DE_plot_era1.png){width=100%}

![Umatilla River, estimated detection efficiency in time period 2.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/umatilla_fitted_DE_plot_era2.png){width=100%}

#### Walla Walla River
![Walla Walla River, estimated detection efficiency in time period 1.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/walla_walla_fitted_DE_plot_era1.png){width=100%}

![Walla Walla River, estimated detection efficiency in time period 2.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/walla_walla_fitted_DE_plot_era2.png){width=100%}

![Walla Walla River, estimated detection efficiency in time period 3.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/walla_walla_fitted_DE_plot_era3.png){width=100%}

![Walla Walla River, estimated detection efficiency in time period 4.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/walla_walla_fitted_DE_plot_era4.png){width=100%}

#### Yakima River
![Yakima River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/yakima_fitted_DE_plot_era1.png){width=100%}

#### Wenatchee River
![Wenatchee River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/wenatchee_fitted_DE_plot_era1.png){width=100%}

#### Entiat River
![Entiat River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/entiat_fitted_DE_plot_era1.png){width=100%}

#### Methow River
![Methow River, estimated detection efficiency in time period 1.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/methow_fitted_DE_plot_era1.png){width=100%}

![Methow River, estimated detection efficiency in time period 2.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/methow_fitted_DE_plot_era2.png){width=100%}

#### Okanogan River
![Okanogan River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/okanogan_fitted_DE_plot_era1.png){width=100%}

#### Tucannon River
![Tucannon River, estimated detection efficiency in time period 1.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/tucannon_fitted_DE_plot_era1.png){width=100%}

![Tucannon River, estimated detection efficiency in time period 2.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/tucannon_fitted_DE_plot_era2.png){width=100%}

#### Asotin Creek
![Asotin Creek, estimated detection efficiency in time period 1.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/asotin_fitted_DE_plot_era1.png){width=100%}

![Asotin Creek, estimated detection efficiency in time period 2.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/asotin_fitted_DE_plot_era2.png){width=100%}

#### Imnaha River
![Imnaha River, estimated detection efficiency.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/detection_efficiency/imnaha_fitted_DE_plot_era1.png){width=100%}





### 6 Model diagnostic figures

![The R-hat convergence diagnostic for each of the six models run. The R-hat convergence diagnostic compares the between- and within-chain estimates for model parameters and other univariate quantities of interest. If chains have not mixed well (i.e., the between- and within-chain estimates dont agree), R-hat is larger than 1. We recommend running at least four chains by default and only using the sample if R-hat is less than 1.05. Stan reports R-hat which is the maximum of rank normalized split-R-hat and rank normalized folded-split-R-hat, which works for thick tailed distributions and is sensitive also to differences in scale.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/diagnostic_plots/rhat_comb_plots.png){width=100%}

<br>

![Bulk Effective Sample Size (bulk-ESS) using rank normalized draws, for each of the six models run. Bulk-ESS is useful measure for sampling efficiency in the bulk of the distribution (related to efficiency of mean and median estimates), and is well defined even if the chains do not have finite mean or variance. Both bulk-ESS and tail-ESS should be at least 100 (approximately) per Markov Chain in order to be reliable and indicate that estimates of respective posterior quantiles are reliable.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/diagnostic_plots/ess_bulk_comb_plots.png){width=100%}

<br>

![Tail Effective Sample Size (tail-ESS) using rank normalized draws, for each of the six models run. Tail-ESS is produces by computing the minimum of effective sample sizes for 5% and 95% quantiles. Tail-ESS is useful measure for sampling efficiency in the tails of the distribution (related to efficiency of variance and tail quantile estimates). Both bulk-ESS and tail-ESS should be at least 100 (approximately) per Markov Chain in order to be reliable and indicate that estimates of respective posterior quantiles are reliable.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/diagnostic_plots/ess_tail_comb_plots.png){width=100%}

### 7 Final fates, under median conditions {.tabset .tabset-pills}
#### Fifteenmile Creek
![Fifteenmile Creek, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/fif_ff_comp_median_plot.png){width=100%}


#### Deschutes River
![Deschutes River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/des_ff_comp_median_plot.png){width=100%}

#### John Day River
![John Day River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/jdr_ff_comp_median_plot.png){width=100%}

#### Umatilla River
![Umatilla River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/uma_ff_comp_median_plot.png){width=100%}

#### Walla Walla River
![Walla Walla River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/wawa_ff_comp_median_plot.png){width=100%}

#### Yakima River
![Yakima River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/yak_ff_comp_median_plot.png){width=100%}

#### Wenatchee River
![Wenatchee River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/wen_ff_comp_median_plot.png){width=100%}

#### Entiat River
![Entiat River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/ent_ff_comp_median_plot.png){width=100%}

#### Methow River
![Methow River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/met_ff_comp_median_plot.png){width=100%}

#### Okanogan River
![Okanogan River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/oka_ff_comp_median_plot.png){width=100%}

#### Tucannon River
![Tucannon River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/tuc_ff_comp_median_plot.png){width=100%}

#### Clearwater River

NOTE: Detection efficiency could not be estimated for the Clearwater River, because of the lack of a site close to the confluence with the Snake River. Therefore, the estimate of final fate in the Clearwater River is biased low, while the estimate of final fate in the mainstem state that connects to the Clearwater river (mainstem, upstream of LGR) is biased high.

<br>

![Clearwater River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/cle_ff_comp_median_plot.png){width=100%}

#### Asotin Creek
![Asotin Creek, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/aso_ff_comp_median_plot.png){width=100%}

#### Grande Ronde River

NOTE: Detection efficiency could not be estimated for the Clearwater River, because of the lack of a site close to the confluence with the Snake River. Therefore, the estimate of final fate in the Clearwater River is biased low, while the estimate of final fate in the mainstem state that connects to the Clearwater river (mainstem, upstream of LGR) is biased high.

<br>

![Grande Ronde River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/gr_ff_comp_median_plot.png){width=100%}

#### Salmon River

NOTE: Detection efficiency could not be estimated for the Clearwater River, because of the lack of a site close to the confluence with the Snake River. Therefore, the estimate of final fate in the Clearwater River is biased low, while the estimate of final fate in the mainstem state that connects to the Clearwater river (mainstem, upstream of LGR) is biased high.

<br>

![Salmon River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/sal_ff_comp_median_plot.png){width=100%}

#### Imnaha River
![Imnaha River, estimated final fates under median conditions from 2005-2024.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/final_fates/imn_ff_comp_median_plot.png){width=100%}

### 8 Deschutes River movement
![Probability of movement into the Deschutes River by temperature, conditional on being in the reach of the mainstem Columbia between Bonneville and McNary Dam. Histograms on the plot margins indicate the temperature experiences of individual fish. Because this movement occurs within the Middle Columbia DPS, those populations have separate probabilities of movement, and are shown in panels A-F, while fish from the Upper Columbia DPS and the Snake River DPS have shared movement probabilities for this movement and are shown in panels G and H.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/paper_figures/Fig5_deschutes_temp_movements.png){width=100%}

### 9 En-route fallback as a function of spill volume {.tabset .tabset-pills}

#### Bonneville Dam
![Probability of fallback at Bonneville Dam, by volume of spill. Because this movement occurs within the Middle Columbia DPS, those populations have separate probabilities of movement, and are shown in panels A-H, while fish from the Upper Columbia DPS and the Snake River DPS have shared movement probabilities for this movement and are shown in panels I-L. Histograms on the plot margins indicate the spill experiences of individual fish.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/paper_figures/spill_volume/BON_spill_fallback.png){width=100%}

#### McNary Dam
![Probability of fallback at McNary Dam, by volume of spill. Because this movement at the juncture between the Middle Columbia, Upper Columbia, and Snake River DPS boundaries, every population has a unique probability of movement. All populations that are downstream of McNary Dam (the Fifteenmile Creek, Deschutes River, John Day River, and Umatilla River) are affected by winter spill days rather than spill volume for this movement, as it is a post-overshoot fallback movement. Histograms on the plot margins indicate the spill experiences of individual fish.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/paper_figures/spill_volume/MCN_spill_fallback.png){width=100%}

#### Ice Harbor Dam
![Probability of fallback at Ice Harbor Dam, by volume of spill. Only Snake River populations are shown because an ascent of Ice Harbor Dam by any populations from the Middle or Upper Columbia would be overshoot and therefore the probability of fallback is affected by winter spill days rather than spill volume. Histograms on the plot margins indicate the spill experiences of individual fish.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/paper_figures/spill_volume/ICH_spill_fallback.png){width=100%}

#### Lower Granite Dam
![Probability of fallback at Lower Granite Dam, by volume of spill. Only Snake River populations are shown because an ascent of Lower Granite Dam by any populations from the Middle or Upper Columbia would be overshoot and therefore the probability of fallback is affected by winter spill days rather than spill volume. The Tucannon River is also not shown because Lower Granite Dam is an overshoot for that population. Histograms on the plot margins indicate the spill experiences of individual fish.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/paper_figures/spill_volume/LGR_spill_fallback.png){width=100%}

### 10 Post-overshoot fallback as a function of March spill

This section presents the results of the same model, but run where only days of spill in March are used as a covariate instead of days of spill in January, February, and March (as is used in the base model).

![The effect of March spill days on movement probabilities out of the mainstem state directly upstream of the mainstem state that connects to the natal tributary for (A) John Day River natural origin Steelhead, (B) Umatilla River natural origin Steelhead, (C) Umatilla River hatchery origin Steelhead, (D) Yakima River natural origin Steelhead, (E) Walla Walla River natural origin Steelhead, (F) Walla Walla River hatchery origin Steelhead, (G) Wenatchee River natural origin Steelhead, (H) Wenatchee River hatchery origin Steelhead, (I) Entiat River natural origin Steelhead, (J) Tucannon River natural origin Steelhead, and (K) Tucannon River hatchery origin Steelhead. Histograms on the plot margins indicate the temperature experiences of individual fish.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/alternative_spill_treatment/paper_figures/Fig6_spilldays_plot.png){width=100%}

<br>

![The homing probability for (A) John Day River, (B) Umatilla River, (C) Walla Walla River, (D) Wenatchee River, (E) Tucannon River, (F) Entiat River, and (G) Yakima River Steelhead under different scenarios for basin-wide temperature and March spill days (0, 10, 20, or 30 days) at the overshoot dam. The temperature scenarios are specific run years from the dataset, with the coldest year being the 2011/2012 run year, the average year being the 2005/2006 run year, and the warmest year being the 2015/2016 run year.](/Users/markusmin/Documents/CBR/CRB_steelhead_adult_movement/figures/alternative_spill_treatment/paper_figures/Fig8_FF_cov_combined_plot_marchspill.png){width=100%}



## References
